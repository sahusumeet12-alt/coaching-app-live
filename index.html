<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#667eea">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="https://ui-avatars.com/api/?name=USP&background=667eea&color=fff&size=180">
<title>UNIQUE STUDY POINT</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Poppins',sans-serif;background:#f0f2f5;min-height:100vh}
.container{max-width:500px;margin:0 auto}
.login-page{min-height:100vh;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;flex-direction:column;align-items:center;padding:40px 20px}
.logo{width:100px;height:100px;background:linear-gradient(135deg,#ff9a56,#ff6b6b);border-radius:25px;display:flex;align-items:center;justify-content:center;margin-bottom:20px;box-shadow:0 15px 35px rgba(0,0,0,0.3)}
.logo span{font-size:36px;font-weight:800;color:#fff}
.brand{text-align:center;color:#fff;margin-bottom:25px}
.brand h1{font-size:22px}
.brand a{color:#ffd700;text-decoration:none}
.login-card{background:#fff;border-radius:28px;padding:30px;width:100%}
.tabs{display:flex;gap:12px;margin-bottom:20px}
.tab-btn{flex:1;padding:15px;border:none;border-radius:16px;background:#f0f2f5;cursor:pointer;font-family:inherit;transition:all .3s}
.tab-btn.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
.tab-btn .icon{font-size:24px;display:block;margin-bottom:4px}
.tab-btn .label{font-size:13px;font-weight:700}
.status{text-align:center;padding:10px;border-radius:12px;margin-bottom:18px;font-size:12px;font-weight:600;background:#d4fc79;color:#2d5a3d}
.form-group{margin-bottom:18px}
.form-group label{display:block;font-size:12px;font-weight:700;color:#667eea;margin-bottom:6px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:14px;border:2px solid #e8e8e8;border-radius:14px;font-size:15px;font-family:inherit}
.btn{width:100%;padding:16px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:14px;font-size:15px;font-weight:700;cursor:pointer}
.btn-sms{background:linear-gradient(135deg,#ff6b6b,#ee5a5a)}
.btn-wa{background:linear-gradient(135deg,#25D366,#128C7E)}
.btn-dl{background:linear-gradient(135deg,#1a365d,#2d5a87)}
.btn-green{background:linear-gradient(135deg,#11998e,#38ef7d)}
.btn-small{padding:8px 12px;font-size:11px;width:auto;border-radius:8px;border:none;cursor:pointer;font-weight:600;color:#fff}
.btn-del{background:#ff6b6b}
.dashboard{display:none}
.dashboard.active{display:block}
.header{background:linear-gradient(135deg,#667eea,#764ba2);padding:25px 20px;color:#fff;text-align:center;position:relative}
.logout-btn{position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.2);border:none;color:#fff;padding:8px 14px;border-radius:10px;cursor:pointer}
.profile-pic{width:80px;height:80px;border-radius:50%;border:3px solid #fff;margin:0 auto 12px;background:#ff9a56;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:800;color:#fff;overflow:hidden}
.profile-pic img{width:100%;height:100%;object-fit:cover}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:15px 20px}
.stat{background:#fff;padding:15px;border-radius:16px;text-align:center}
.stat-val{font-size:20px;font-weight:800;color:#667eea}
.stat-lbl{font-size:9px;color:#888;font-weight:600}
.section{padding:0 20px}
.section-title{font-size:15px;font-weight:700;color:#667eea;margin:18px 0 12px}
.actions{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.action{background:#fff;border:none;padding:20px;border-radius:16px;text-align:center;cursor:pointer;font-family:inherit}
.action-icon{font-size:28px;margin-bottom:6px}
.action-label{font-size:11px;font-weight:700}
.list{padding:0 20px}
.card{background:#fff;border-radius:16px;padding:14px;margin-bottom:10px;display:flex;align-items:center;gap:12px}
.avatar{width:46px;height:46px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;flex-shrink:0;overflow:hidden}
.avatar img{width:100%;height:100%;object-fit:cover}
.card-info{flex:1;min-width:0}
.card-title{font-weight:600;color:#333;font-size:13px}
.card-sub{font-size:10px;color:#888}
.nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:500px;background:#fff;padding:10px;display:flex;justify-content:space-around;box-shadow:0 -8px 30px rgba(0,0,0,0.1);border-radius:22px 22px 0 0;z-index:100}
.nav-item{display:flex;flex-direction:column;align-items:center;background:transparent;border:none;cursor:pointer;padding:6px 10px;border-radius:12px;font-family:inherit}
.nav-item.active{background:rgba(102,126,234,0.15)}
.nav-item span:first-child{font-size:20px}
.nav-item span:last-child{font-size:8px;font-weight:700;color:#888}
.nav-item.active span:last-child{color:#667eea}
.page{display:none;padding-bottom:85px}
.page.active{display:block}
.filter-row{display:flex;gap:8px;padding:0 20px;margin-bottom:12px;flex-wrap:wrap}
.filter-btn{padding:8px 14px;border:2px solid #e8e8e8;border-radius:25px;background:#fff;font-size:11px;font-weight:600;cursor:pointer}
.filter-btn.active{border-color:#667eea;background:#667eea;color:#fff}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:15px}
.modal.active{display:flex}
.modal-content{background:#fff;border-radius:22px;width:100%;max-width:420px;max-height:85vh;overflow-y:auto}
.modal-header{padding:18px;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center}
.modal-title{font-size:16px;font-weight:700;color:#667eea}
.modal-close{background:#ff6b6b;border:none;color:#fff;width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:16px}
.modal-body{padding:18px}
.modal-footer{padding:12px 18px 18px;display:flex;gap:8px;flex-wrap:wrap}
.modal-footer .btn{flex:1;padding:12px}
.toast{position:fixed;top:15px;left:50%;transform:translateX(-50%) translateY(-100px);background:#667eea;color:#fff;padding:12px 22px;border-radius:12px;font-size:13px;font-weight:600;z-index:2000;transition:transform .3s}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.success{background:#25D366}
.toast.error{background:#ff6b6b}
.empty{text-align:center;padding:40px;color:#888}
.upload-box{background:#f0f2f5;border:2px dashed #667eea;border-radius:16px;padding:30px;text-align:center;cursor:pointer}
.file-preview{background:#f0f2f5;border-radius:12px;padding:12px;margin-bottom:15px;display:none;align-items:center;gap:10px}
.photo-upload{width:80px;height:80px;border-radius:50%;border:3px dashed #667eea;margin:0 auto 15px;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;background:#f0f2f5}
.photo-upload img{width:100%;height:100%;object-fit:cover}
.chart-box{background:#fff;border-radius:16px;padding:15px;margin:0 20px 15px}
.chart-box h3{font-size:13px;color:#1a365d;margin-bottom:10px}
.chart-wrap{height:200px}
.result-card{background:#fff;border-radius:16px;padding:15px;margin:0 20px 10px;display:flex;align-items:center;gap:15px;border-left:4px solid #1a365d}
.score-circle{width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:16px}
.test-card,.ws-card{background:#fff;border-radius:16px;padding:16px;margin:0 20px 12px;border-left:4px solid #667eea}
.alert-card{background:#fff;border-radius:12px;padding:12px;margin-bottom:8px;border-left:4px solid #ff6b6b}
.alert-card.positive{border-left-color:#25D366}
.alert-card.info{border-left-color:#667eea}
@keyframes pulse{0%{transform:scale(1);box-shadow:0 0 0 0 rgba(255,0,0,0.7)}50%{transform:scale(1.1);box-shadow:0 0 0 8px rgba(255,0,0,0)}100%{transform:scale(1);box-shadow:0 0 0 0 rgba(255,0,0,0)}}
#notifCount{animation:pulse 1.5s infinite}
#notifBadge{transition:background 0.3s}
.notif-unread{background:#fff0f0!important;border-left:4px solid #ff0000!important}
</style>
</head>
<body>
<div class="container">
<!-- Login Page -->
<div class="login-page" id="loginPage">
<div class="logo"><span>USP</span></div>
<div class="brand">
<h1>âœ¨ UNIQUE STUDY POINT</h1>
<p>By Sumeet Sahu</p>
<p style="margin-top:8px"><a href="https://www.uniquestudyonline.com" target="_blank">ğŸŒ www.uniquestudyonline.com</a></p>
</div>
<div class="login-card">
<div class="tabs">
<button class="tab-btn active" id="parentTab" onclick="ut='parent';this.classList.add('active');document.getElementById('adminTab').classList.remove('active')"><span class="icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span><span class="label">Parent</span></button>
<button class="tab-btn" id="adminTab" onclick="ut='admin';this.classList.add('active');document.getElementById('parentTab').classList.remove('active')"><span class="icon">ğŸ‘¨â€ğŸ’¼</span><span class="label">Admin</span></button>
</div>
<div class="status" id="connStatus">â— Connecting...</div>
<div class="form-group"><label>USER ID</label><input type="text" id="userId" placeholder="Enter User ID"></div>
<div class="form-group"><label>PASSWORD</label><input type="password" id="password" placeholder="Enter Password"></div>
<button class="btn" onclick="doLogin()">ğŸš€ Login</button>
</div>
</div>

<!-- Parent Dashboard -->
<div class="dashboard" id="parentDash">
<div class="page active" id="pHome">
<div class="header">
<div style="position:absolute;top:20px;right:20px;display:flex;gap:8px">
<button id="notifBadge" onclick="showP('pAlerts');renPAlerts();markAlertsRead()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;padding:8px 14px;border-radius:10px;cursor:pointer;position:relative;animation:none">ğŸ””<span id="notifCount" style="position:absolute;top:-8px;right:-8px;background:#ff0000;color:#fff;font-size:11px;font-weight:bold;padding:4px 8px;border-radius:50%;min-width:20px;text-align:center;box-shadow:0 2px 8px rgba(255,0,0,0.6);display:none;align-items:center;justify-content:center">0</span></button>
<button class="logout-btn" onclick="logout()" style="position:static">ğŸšª</button>
</div>
<div class="profile-pic" id="pPhoto"><span id="pInit">S</span></div>
<h1 id="pWelcome">Welcome</h1>
<p>UNIQUE STUDY POINT</p>
</div>
<div class="stats">
<div class="stat"><div class="stat-val" id="pRank">#-</div><div class="stat-lbl">CLASS RANK</div></div>
<div class="stat"><div class="stat-val" id="pAvgPct">0%</div><div class="stat-lbl">AVG SCORE</div></div>
<div class="stat"><div class="stat-val" id="pAttPct">0%</div><div class="stat-lbl">ATTENDANCE</div></div>
</div>
<div style="background:#fff;margin:0 20px 15px;padding:15px;border-radius:16px">
<div style="display:flex;justify-content:space-between;align-items:center">
<div><span style="font-size:11px;color:#888">Tests Taken</span><br><strong id="pTestCnt">0</strong></div>
<div><span style="font-size:11px;color:#888">Present Days</span><br><strong id="pAttDays">0</strong></div>
<div><span style="font-size:11px;color:#888">Class Average</span><br><strong id="pClassAvg">0%</strong></div>
</div>
</div>
<div id="parentBadges" style="padding:0 20px;margin-bottom:10px"></div>
<div class="section">
<h3 class="section-title">âš¡ Quick Access</h3>
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:15px">
<button style="background:#fff;border:none;padding:12px 8px;border-radius:12px;cursor:pointer" onclick="showP('pAttendance');renPAtt()"><div style="font-size:20px">ğŸ“‹</div><div style="font-size:9px;font-weight:600">Attendance</div></button>
<button style="background:#fff;border:none;padding:12px 8px;border-radius:12px;cursor:pointer" onclick="showP('pAlerts');renPAlerts()"><div style="font-size:20px">ğŸ””</div><div style="font-size:9px;font-weight:600">Alerts</div></button>
<button style="background:#fff;border:none;padding:12px 8px;border-radius:12px;cursor:pointer" onclick="showP('pMaterials');renPMat()"><div style="font-size:20px">ğŸ“š</div><div style="font-size:9px;font-weight:600">Materials</div></button>
<button style="background:#fff;border:none;padding:12px 8px;border-radius:12px;cursor:pointer" onclick="showP('pLeave');renPLeave()"><div style="font-size:20px">âœ‹</div><div style="font-size:9px;font-weight:600">Leave</div></button>
</div>
<h3 class="section-title">ğŸ”” Recent Alerts</h3>
</div>
<div class="list" id="notifList"></div>
</div>

<div class="page" id="pResults">
<div class="header"><h1>ğŸ“ Results</h1></div>
<div class="filter-row" id="resFilters" style="margin-top:15px"></div>
<div id="resultsList"></div>
<div class="chart-box" id="barChartBox" style="display:none">
<h3>ğŸ“ˆ Performance Trend</h3>
<div class="chart-wrap"><canvas id="barChart"></canvas></div>
</div>
<div class="chart-box" id="pieChartBox" style="display:none">
<h3>ğŸ“ˆ Subject-wise Pie Chart</h3>
<div class="chart-wrap"><canvas id="pieChart"></canvas></div>
</div>
<div style="padding:15px 20px"><button class="btn btn-dl" onclick="viewReport()">ğŸ“¥ Download Report Card</button></div>
</div>

<div class="page" id="pMaterials">
<div class="header"><h1>ğŸ“š Study Materials</h1></div>
<div class="filter-row" id="pMatFilters" style="margin-top:15px"></div>
<div class="list" id="pMatList"></div>
</div>

<div class="page" id="pAlerts">
<div class="header"><h1>ğŸ”” Alert History</h1></div>
<div style="padding:15px 20px"><button class="btn btn-dl" onclick="downloadAlertPDF()">ğŸ“¥ Download Report</button></div>
<div class="list" id="pAlertsList"></div>
</div>

<div class="page" id="pLeave">
<div class="header"><h1>ğŸ“ Leave Request</h1></div>
<div class="section" style="padding-top:15px">
<div class="form-group"><label>From Date</label><input type="date" id="leaveFrom"></div>
<div class="form-group"><label>To Date</label><input type="date" id="leaveTo"></div>
<div class="form-group"><label>Reason</label><textarea id="leaveReason" rows="3" placeholder="Enter reason for leave..."></textarea></div>
<button class="btn" onclick="submitLeave()">ğŸ“¤ Submit Leave Request</button>
</div>
<h3 class="section-title" style="margin-top:20px">ğŸ“‹ My Leave Requests</h3>
<div class="list" id="pLeaveList"></div>
</div>

<div class="page" id="pAttendance">
<div class="header"><h1>ğŸ“‹ My Attendance</h1></div>
<div class="stats" style="margin-top:0">
<div class="stat"><div class="stat-val" id="pTotalDays">0</div><div class="stat-lbl">TOTAL</div></div>
<div class="stat"><div class="stat-val" id="pPresentDays">0</div><div class="stat-lbl">PRESENT</div></div>
<div class="stat"><div class="stat-val" id="pAttPercent">0%</div><div class="stat-lbl">PERCENTAGE</div></div>
</div>
<div style="padding:15px 20px"><button class="btn btn-dl" onclick="downloadPAttPDF()">ğŸ“¥ Download Attendance Report</button></div>
<div id="pAttMonthList" style="padding:0 20px"></div>
</div>

<div class="page" id="pFees">
<div class="header"><h1>ğŸ’° Fees</h1></div>
<div style="background:linear-gradient(135deg,#667eea,#764ba2);margin:0 20px 15px;padding:22px;border-radius:18px;color:#fff">
<div style="font-size:12px;opacity:0.9">Pending Amount</div>
<div style="font-size:32px;font-weight:800" id="feePend">â‚¹0</div>
<div style="font-size:11px;margin-top:8px" id="feeStat">Clear</div>
</div>
<div class="list" id="feeList"></div>
</div>

<div class="nav" id="pNav"></div>
</div>

<!-- Admin Dashboard -->
<div class="dashboard" id="adminDash">
<div class="page active" id="aHome">
<div class="header" style="padding-bottom:50px">
<button class="logout-btn" onclick="logout()">ğŸšª</button>
<p>Admin Panel</p>
<h1>Sumeet Sahu</h1>
</div>
<div class="stats" style="margin-top:-30px">
<div class="stat"><div class="stat-val" id="aStu">0</div><div class="stat-lbl">STUDENTS</div></div>
<div class="stat"><div class="stat-val" id="aPre">0</div><div class="stat-lbl">PRESENT</div></div>
<div class="stat"><div class="stat-val" id="aTst">0</div><div class="stat-lbl">TESTS</div></div>
</div>
<div id="adminBirthdayBanner"></div>
<div class="section">
<h3 class="section-title">âš¡ Quick Actions</h3>
<div class="actions" id="quickActions"></div>
<h3 class="section-title">ğŸ‘¨â€ğŸ“ Students</h3>
</div>
<div class="filter-row" id="clsFilters"></div>
<div class="list" id="aList"></div>
</div>

<div class="page" id="aAtt">
<div class="header"><h1>ğŸ“‹ Attendance</h1></div>
<div class="section" style="padding-top:15px">
<div class="form-group"><label>Date</label><input type="date" id="attD" onchange="renAtt()"></div>
<div class="form-group"><label>Month (PDF)</label><input type="month" id="attMonth"></div>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<button class="btn btn-sms" onclick="sendAttSMS()" style="flex:1">ğŸ“± SMS</button>
<button class="btn btn-wa" onclick="sendAttWA()" style="flex:1">ğŸ’¬ WA</button>
<button class="btn btn-dl" onclick="downloadAttPDF()" style="flex:1">ğŸ“¥ PDF</button>
</div>
</div>
<div class="list" id="attL" style="margin-top:12px"></div>
</div>

<div class="page" id="aTests">
<div class="header"><h1>ğŸ“ Tests</h1></div>
<div class="section" style="padding-top:15px">
<button class="btn" onclick="openM('addTModal')">â• Create Test</button>
</div>
<div class="list" id="testL" style="margin-top:12px"></div>
</div>

<div class="page" id="aWorksheets">
<div class="header"><h1>ğŸ“š Worksheets</h1></div>
<div class="section" style="padding-top:15px">
<button class="btn btn-green" onclick="openM('wsModal')">ğŸ“¤ Upload</button>
</div>
<div class="filter-row" id="wsFilters" style="margin-top:15px"></div>
<div class="list" id="aWsList" style="margin-top:12px"></div>
</div>

<div class="page" id="aFees">
<div class="header"><h1>ğŸ’° Fees</h1></div>
<div class="section" style="padding-top:15px">
<button class="btn" onclick="ldDD();openM('addFModal')">ğŸ’° Record Payment</button>
</div>
<div class="list" id="feeL" style="margin-top:12px"></div>
</div>

<div class="page" id="aAnalytics">
<div class="header"><h1>ğŸ“Š Analytics</h1></div>
<div class="section" style="padding-top:15px">
<button class="btn btn-dl" onclick="genAllReports()" style="margin-bottom:10px">ğŸ“¥ Generate All Monthly Reports</button>
</div>

<!-- Class-wise Topper List -->
<div class="section"><h3 class="section-title">ğŸ† Class-wise Toppers</h3></div>
<div id="topperList" style="padding:0 20px"></div>

<!-- Weak Students -->
<div class="section"><h3 class="section-title">âš ï¸ Weak Students (Below 40%)</h3></div>
<div id="weakList" style="padding:0 20px"></div>
<div style="padding:10px 20px"><button class="btn btn-sms" onclick="alertWeakParents()">ğŸ“± Alert All Weak Students' Parents</button></div>

<!-- Attendance Warning -->
<div class="section"><h3 class="section-title">ğŸ“‹ Low Attendance (Below 75%)</h3></div>
<div id="lowAttList" style="padding:0 20px"></div>
<div style="padding:10px 20px"><button class="btn btn-sms" onclick="alertLowAttParents()">ğŸ“± Alert Low Attendance Parents</button></div>

<!-- Fee Pending -->
<div class="section"><h3 class="section-title">ğŸ’° Fee Pending Students</h3></div>
<div id="feePendingList" style="padding:0 20px"></div>
<div style="padding:10px 20px"><button class="btn btn-sms" onclick="alertFeePending()">ğŸ“± Send Fee Reminder to All</button></div>

<!-- Clear Data Section -->
<div class="section"><h3 class="section-title">ğŸ—‘ï¸ Clear Data (Reset)</h3></div>
<div style="padding:10px 20px 100px">
<p style="color:#ff6b6b;font-size:12px;margin-bottom:15px">âš ï¸ Warning: This will permanently delete selected data. Students will NOT be deleted.</p>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
<button class="btn" style="background:#ff6b6b" onclick="clearAttendance()">ğŸ—‘ï¸ Attendance</button>
<button class="btn" style="background:#ff6b6b" onclick="clearTests()">ğŸ—‘ï¸ Tests/Results</button>
<button class="btn" style="background:#ff6b6b" onclick="clearAlerts()">ğŸ—‘ï¸ All Alerts</button>
<button class="btn" style="background:#ff6b6b" onclick="clearFees()">ğŸ—‘ï¸ Fee Records</button>
</div>
<button class="btn" style="background:#cc0000;margin-top:15px;width:100%" onclick="clearAllData()">âš ï¸ CLEAR ALL DATA</button>
</div>
</div>

<div class="page" id="aAlerts">
<div class="header"><h1>ğŸ”” Manage Alerts</h1></div>
<div class="section" style="padding-top:15px">
<button class="btn" onclick="ldDD();openM('alertModal')">ğŸ“¤ Send New Alert</button>
</div>
<div class="list" id="adminAlertList" style="margin-top:12px"></div>
</div>

<div class="page" id="aLeave">
<div class="header"><h1>âœ‹ Leave Requests</h1></div>
<div class="filter-row" style="margin-top:15px">
<button class="filter-btn active" onclick="setLeaveF(this,'all')">All</button>
<button class="filter-btn" onclick="setLeaveF(this,'pending')">Pending</button>
<button class="filter-btn" onclick="setLeaveF(this,'approved')">Approved</button>
<button class="filter-btn" onclick="setLeaveF(this,'rejected')">Rejected</button>
</div>
<div class="list" id="adminLeaveList" style="margin-top:12px"></div>
</div>

<div class="nav" id="aNav"></div>
</div>
</div>
<!-- Modals -->
<div class="modal" id="addSModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">â• Add Student</h2><button class="modal-close" onclick="closeM('addSModal')">Ã—</button></div><div class="modal-body">
<div class="photo-upload" id="addPhotoBox" onclick="document.getElementById('addPhotoInput').click()"><span style="font-size:28px">ğŸ“·</span></div>
<input type="file" id="addPhotoInput" accept="image/*" style="display:none" onchange="upPhoto(this,'add')">
<div class="form-group"><label>Name *</label><input type="text" id="sN"></div>
<div class="form-group"><label>Class *</label><select id="sC"><option value="">Select</option><option>VI</option><option>VII</option><option>VIII</option><option>IX</option><option>X</option></select></div>
<div class="form-group"><label>Mobile 1 (Primary) *</label><input type="tel" id="sM" maxlength="10" placeholder="Student/Father"></div>
<div class="form-group"><label>Mobile 2 (Optional)</label><input type="tel" id="sM2" maxlength="10" placeholder="Mother"></div>
<div class="form-group"><label>Mobile 3 (Optional)</label><input type="tel" id="sM3" maxlength="10" placeholder="Guardian"></div>
<div class="form-group"><label>User ID *</label><input type="text" id="sU"></div>
<div class="form-group"><label>Password *</label><input type="text" id="sP"></div>
<div class="form-group"><label>Fee</label><input type="number" id="sFee" value="500"></div>
<div class="form-group"><label>Join Date</label><input type="date" id="sJoin"></div>
<div class="form-group"><label>Date of Birth</label><input type="date" id="sDOB"></div>
</div><div class="modal-footer"><button class="btn" onclick="saveS()">Add Student</button></div></div></div>

<div class="modal" id="editSModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">âœï¸ Edit Student</h2><button class="modal-close" onclick="closeM('editSModal')">Ã—</button></div><div class="modal-body">
<div class="photo-upload" id="editPhotoBox" onclick="document.getElementById('editPhotoInput').click()"><span style="font-size:28px">ğŸ“·</span></div>
<input type="file" id="editPhotoInput" accept="image/*" style="display:none" onchange="upPhoto(this,'edit')">
<input type="hidden" id="editSId">
<div class="form-group"><label>Name</label><input type="text" id="editSN"></div>
<div class="form-group"><label>Class</label><select id="editSC"><option value="">Select</option><option>VI</option><option>VII</option><option>VIII</option><option>IX</option><option>X</option></select></div>
<div class="form-group"><label>Mobile 1 (Primary)</label><input type="tel" id="editSM" maxlength="10"></div>
<div class="form-group"><label>Mobile 2</label><input type="tel" id="editSM2" maxlength="10"></div>
<div class="form-group"><label>Mobile 3</label><input type="tel" id="editSM3" maxlength="10"></div>
<div class="form-group"><label>User ID</label><input type="text" id="editSU"></div>
<div class="form-group"><label>Password</label><input type="text" id="editSP"></div>
<div class="form-group"><label>Fee</label><input type="number" id="editSFee"></div>
<div class="form-group"><label>Join</label><input type="date" id="editSJoin"></div>
<div class="form-group"><label>DOB</label><input type="date" id="editSDOB"></div>
</div><div class="modal-footer"><button class="btn btn-green" onclick="updateS()">ğŸ’¾ Update</button><button class="btn btn-del" style="background:#ff6b6b" onclick="deleteS()">ğŸ—‘ï¸ Delete</button></div></div></div>

<div class="modal" id="addTModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">ğŸ“ Create Test</h2><button class="modal-close" onclick="closeM('addTModal')">Ã—</button></div><div class="modal-body">
<div class="form-group"><label>Test Name *</label><input type="text" id="tN"></div>
<div class="form-group"><label>Subject *</label><select id="tSubj"><option value="">Select</option><option value="Mathematics">Mathematics</option><option value="Science">Science</option><option value="Social Science">Social Science</option><option value="Hindi">Hindi</option><option value="English">English</option></select></div>
<div class="form-group"><label>Class *</label><select id="tClass"><option value="">All Classes</option><option>VI</option><option>VII</option><option>VIII</option><option>IX</option><option>X</option></select></div>
<div class="form-group"><label>Total Marks</label><input type="number" id="tM" value="50"></div>
<div class="form-group"><label>Date</label><input type="date" id="tD"></div>
<div class="form-group"><label>Notify</label><select id="tNotify"><option value="none">Don't Notify</option><option value="all">All Parents</option><option value="class">Class Students Only</option></select></div>
</div><div class="modal-footer"><button class="btn" onclick="saveT()">Create Test</button></div></div></div>

<div class="modal" id="addMkModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">ğŸ“ <span id="mkTN"></span></h2><button class="modal-close" onclick="closeM('addMkModal')">Ã—</button></div><div class="modal-body"><div id="mkL"></div></div><div class="modal-footer"><button class="btn" onclick="saveMk()">ğŸ’¾ Save</button><button class="btn btn-sms" onclick="saveMk();setTimeout(sendMkSMS,500)">ğŸ“±</button><button class="btn btn-wa" onclick="saveMk();setTimeout(sendMkWA,500)">ğŸ’¬</button></div></div></div>

<div class="modal" id="addFModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">ğŸ’° Record Fee</h2><button class="modal-close" onclick="closeM('addFModal')">Ã—</button></div><div class="modal-body">
<div class="form-group"><label>Student</label><select id="fStu"></select></div>
<div class="form-group"><label>Amount</label><input type="number" id="fAmt"></div>
<div class="form-group"><label>Date</label><input type="date" id="fDate"></div>
<div class="form-group"><label>Remark</label><input type="text" id="fRemark" placeholder="e.g. June month fee"></div>
</div><div class="modal-footer"><button class="btn" onclick="saveF()">Save</button></div></div></div>

<div class="modal" id="alertModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">ğŸ”” Send Alert</h2><button class="modal-close" onclick="closeM('alertModal')">Ã—</button></div><div class="modal-body">
<div class="form-group"><label>Student</label><select id="alertStu"></select></div>
<div class="form-group"><label>Message</label><textarea id="alertMsg" rows="3" placeholder="Type or select template..."></textarea></div>
<button type="button" class="btn" style="background:#f0f2f5;color:#667eea;margin-bottom:10px" onclick="openM('alertTplModal')">ğŸ“ Select Template</button>
</div><div class="modal-footer"><button class="btn btn-sms" onclick="sendAlertSMS()">ğŸ“± SMS</button><button class="btn btn-wa" onclick="sendAlertWA()">ğŸ’¬ WA</button></div></div></div>

<div class="modal" id="wsModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">ğŸ“¤ Upload Worksheet</h2><button class="modal-close" onclick="closeM('wsModal')">Ã—</button></div><div class="modal-body">
<div class="form-group"><label>Class</label><select id="wsClass"><option value="">Select</option><option>VI</option><option>VII</option><option>VIII</option><option>IX</option><option>X</option><option value="ALL">ALL</option></select></div>
<div class="form-group"><label>Subject</label><select id="wsSubject"><option value="">Select</option><option value="Mathematics">Mathematics</option><option value="Science">Science</option><option value="Social Science">Social Science</option><option value="Hindi">Hindi</option><option value="English">English</option></select></div>
<div class="form-group"><label>Title</label><input type="text" id="wsTitle"></div>
<div class="upload-box" id="uploadBox" onclick="document.getElementById('wsFile').click()">
<div style="font-size:40px">ğŸ“</div>
<div style="color:#667eea;font-weight:600">Click to Select File</div>
</div>
<div class="file-preview" id="filePreview"><span>ğŸ“„</span><span id="fileName" style="flex:1"></span><button type="button" onclick="clearFileSelection()" style="background:#ff6b6b;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer">âœ•</button></div>
<input type="file" id="wsFile" style="display:none" onchange="if(this.files.length){document.getElementById('fileName').textContent=this.files[0].name;document.getElementById('filePreview').style.display='flex';document.getElementById('uploadBox').style.display='none'}">
</div><div class="modal-footer"><button class="btn btn-green" onclick="saveWs()">ğŸ“¤ Upload</button></div></div></div>

<div class="modal" id="editFModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">âœï¸ Edit Fee</h2><button class="modal-close" onclick="closeM('editFModal')">Ã—</button></div><div class="modal-body">
<input type="hidden" id="editFId">
<div class="form-group"><label>Amount</label><input type="number" id="editFAmt"></div>
<div class="form-group"><label>Date</label><input type="date" id="editFDate"></div>
<div class="form-group"><label>Remark</label><input type="text" id="editFRemark" placeholder="e.g. June month fee"></div>
</div><div class="modal-footer"><button class="btn btn-green" onclick="updateFee()">ğŸ’¾ Update</button><button class="btn btn-del" onclick="deleteFee()">ğŸ—‘ï¸ Delete</button></div></div></div>

<div class="modal" id="alertTplModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">ğŸ“ Alert Templates</h2><button class="modal-close" onclick="closeM('alertTplModal')">Ã—</button></div><div class="modal-body">
<h4 style="color:#ff6b6b;margin-bottom:8px">âš ï¸ Negative Alerts</h4>
<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:15px">
<button class="btn-small" style="background:#ff6b6b" onclick="setAlertTpl('was ABSENT today')">Absent</button>
<button class="btn-small" style="background:#ff6b6b" onclick="setAlertTpl('came LATE to class')">Late</button>
<button class="btn-small" style="background:#ff6b6b" onclick="setAlertTpl('homework not completed')">No HW</button>
<button class="btn-small" style="background:#ff6b6b" onclick="setAlertTpl('poor performance in test')">Poor Test</button>
<button class="btn-small" style="background:#ff6b6b" onclick="setAlertTpl('indiscipline in class')">Indiscipline</button>
<button class="btn-small" style="background:#ff6b6b" onclick="setAlertTpl('fees pending, please clear')">Fee Due</button>
</div>
<h4 style="color:#25D366;margin-bottom:8px">âœ… Positive Alerts</h4>
<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:15px">
<button class="btn-small" style="background:#25D366" onclick="setAlertTpl('excellent performance!')">Excellent</button>
<button class="btn-small" style="background:#25D366" onclick="setAlertTpl('good progress in studies')">Good Progress</button>
<button class="btn-small" style="background:#25D366" onclick="setAlertTpl('homework completed on time')">HW Done</button>
<button class="btn-small" style="background:#25D366" onclick="setAlertTpl('topped in test!')">Test Topper</button>
<button class="btn-small" style="background:#25D366" onclick="setAlertTpl('very active in class')">Active</button>
<button class="btn-small" style="background:#25D366" onclick="setAlertTpl('fees paid, thank you!')">Fee Paid</button>
</div>
<h4 style="color:#667eea;margin-bottom:8px">â„¹ï¸ Info Alerts</h4>
<div style="display:flex;flex-wrap:wrap;gap:6px">
<button class="btn-small" style="background:#667eea" onclick="setAlertTpl('holiday tomorrow')">Holiday</button>
<button class="btn-small" style="background:#667eea" onclick="setAlertTpl('PTM scheduled this week')">PTM</button>
<button class="btn-small" style="background:#667eea" onclick="setAlertTpl('exam starting from next week')">Exam Notice</button>
<button class="btn-small" style="background:#667eea" onclick="setAlertTpl('new batch timings updated')">Timing Change</button>
</div>
</div></div></div>

<div class="modal" id="editAlertModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">âœï¸ Edit Alert</h2><button class="modal-close" onclick="closeM('editAlertModal')">Ã—</button></div><div class="modal-body">
<input type="hidden" id="editAlertId">
<div class="form-group"><label>Sent To</label><input type="text" id="editAlertTo" disabled style="background:#f0f2f5"></div>
<div class="form-group"><label>Message</label><textarea id="editAlertMsg" rows="3"></textarea></div>
<div class="form-group"><label>Sent On</label><input type="text" id="editAlertTime" disabled style="background:#f0f2f5"></div>
</div><div class="modal-footer">
<button class="btn btn-green" onclick="updateAlert()">ğŸ’¾ Update</button>
<button class="btn btn-del" onclick="confirmDelAlert()">ğŸ—‘ï¸ Delete</button>
</div></div></div>

<div class="toast" id="toast"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
<script>
firebase.initializeApp({apiKey:"AIzaSyA5FjFHqFRBiGlLVe-jn7njpfXzf8hQ1cY",authDomain:"unique-study-point-2.firebaseapp.com",databaseURL:"https://unique-study-point-2-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"unique-study-point-2"});
var db=firebase.database(),cu=null,ut='parent',stu=[],tst=[],res=[],att=[],fee=[],alerts=[],worksheets=[],ctid=null,curFilter='all',wsFilter='all',resFilter='all',matFilter='all',pieChart=null,addPhotoUrl='',editPhotoUrl='',
td=new Date().toISOString().split('T')[0],PHONE='8103405051',CLOUD='dukrrfqf6',leaves=[],leaveFilter='all';
var messaging=null,VAPID_KEY='BEK5WTxT4NhkW53BQLb51GwRbmQAgc_vE2OMBhsPZcNNKXGcpGcKoJdnA6Eog7s42k8odn_EcYFGaMq-xzBfv5k';
document.getElementById('tD').value=td;document.getElementById('fDate').value=td;document.getElementById('attD').value=td;document.getElementById('sJoin').value=td;document.getElementById('attMonth').value=td.substring(0,7);

// FCM Push Notification Functions
function initFCM(){
if('serviceWorker' in navigator){
navigator.serviceWorker.register('firebase-messaging-sw.js').then(function(reg){
console.log('SW registered');
if(firebase.messaging){
messaging=firebase.messaging();
messaging.useServiceWorker(reg);
}
}).catch(function(e){console.log('SW error:',e)});
}
}

function requestNotifPermission(){
if(!('Notification' in window))return;
Notification.requestPermission().then(function(p){
if(p==='granted'&&messaging&&cu){
messaging.getToken({vapidKey:VAPID_KEY}).then(function(token){
if(token){
db.ref('fcmTokens/'+cu.id).set({token:token,time:Date.now()});
toast('Notifications enabled!','success');
}
}).catch(function(e){console.log('Token error:',e)});
}
});
}

function setupFCMListener(){
if(!messaging)return;
messaging.onMessage(function(payload){
var body=payload.notification?.body||payload.data?.message||'New notification';
toast(body,'success');
if(Notification.permission==='granted'){
new Notification('UNIQUE STUDY POINT',{body:body,icon:'https://ui-avatars.com/api/?name=USP&background=667eea&color=fff&size=192'});
}
});
}

initFCM();

function toast(m,t){var e=document.getElementById('toast');e.textContent=m;e.className='toast show '+(t||'');setTimeout(function(){e.classList.remove('show')},3000)}
function openM(id){document.getElementById(id).classList.add('active')}
function closeM(id){document.getElementById(id).classList.remove('active')}
function logout(){cu=null;localStorage.removeItem('usp_user');location.reload()}
function formatDate(d){return d?new Date(d).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}):'N/A'}
function getMonth(){var m=['January','February','March','April','May','June','July','August','September','October','November','December'];return m[new Date().getMonth()]+' '+new Date().getFullYear()}
function getGrade(p){if(p>=90)return{g:'A+',c:'#27ae60',r:'Outstanding!'};if(p>=80)return{g:'A',c:'#2ecc71',r:'Excellent!'};if(p>=70)return{g:'B+',c:'#3498db',r:'Very good!'};if(p>=60)return{g:'B',c:'#9b59b6',r:'Good effort.'};if(p>=50)return{g:'C',c:'#f1c40f',r:'Average.'};if(p>=40)return{g:'D',c:'#e67e22',r:'Below average.'};return{g:'F',c:'#e74c3c',r:'Needs improvement.'}}
function getAlertType(msg){var neg=['absent','late','indiscipline','poor','low'];for(var i=0;i<neg.length;i++)if(msg.toLowerCase().indexOf(neg[i])>=0)return'negative';return'positive'}

function uploadToCloudinary(file,cb){
toast('Uploading...','');
var reader=new FileReader();
reader.onload=function(e){
var base64=e.target.result;
// Store all files as base64 in Firebase (works for images, PDFs, docs)
cb(base64);
toast('Uploaded!','success');
};
reader.onerror=function(){cb(null);toast('Read failed','error')};
reader.readAsDataURL(file);
}

function upPhoto(inp,type){
if(!inp.files.length)return;
uploadToCloudinary(inp.files[0],function(url){
if(url){
if(type==='add'){addPhotoUrl=url;document.getElementById('addPhotoBox').innerHTML='<img src="'+url+'">'}
else{editPhotoUrl=url;document.getElementById('editPhotoBox').innerHTML='<img src="'+url+'">'}
}
})
}

db.ref('.info/connected').on('value',function(s){document.getElementById('connStatus').textContent=s.val()?'âœ… Connected':'âš ï¸ Offline'});
db.ref('students').on('value',function(s){stu=[];s.forEach(function(c){stu.push(Object.assign({id:c.key},c.val()))});render()});
db.ref('tests').on('value',function(s){tst=[];s.forEach(function(c){if(c.val()&&c.val().name)tst.push(Object.assign({id:c.key},c.val()))});render()});
db.ref('results').on('value',function(s){res=[];s.forEach(function(c){res.push(Object.assign({id:c.key},c.val()))});render()});
db.ref('attendance').on('value',function(s){att=[];s.forEach(function(c){att.push(Object.assign({id:c.key},c.val()))});render()});
db.ref('fees').on('value',function(s){fee=[];s.forEach(function(c){fee.push(Object.assign({id:c.key},c.val()))});render()});
db.ref('alerts').on('value',function(s){alerts=[];s.forEach(function(c){alerts.push(Object.assign({id:c.key},c.val()))});render();updateNotifBadge()});
db.ref('worksheets').on('value',function(s){worksheets=[];s.forEach(function(c){worksheets.push(Object.assign({id:c.key},c.val()))});render()});
db.ref('leaves').on('value',function(s){leaves=[];s.forEach(function(c){leaves.push(Object.assign({id:c.key},c.val()))});render()});

var sv=localStorage.getItem('usp_user');if(sv){cu=JSON.parse(sv);if(cu.role==='admin')showAdmin();else showParent()}

function doLogin(){
var u=document.getElementById('userId').value.trim(),p=document.getElementById('password').value;
if(!u||!p)return toast('Enter credentials','error');
if(ut==='admin'){
if(u==='admin'&&p==='admin123'){cu={role:'admin'};localStorage.setItem('usp_user',JSON.stringify(cu));showAdmin()}
else toast('Invalid','error')
}else{
var found=null;
for(var i=0;i<stu.length;i++){if(stu[i].userId===u&&stu[i].password===p){found=stu[i];break}}
if(found){cu={role:'parent',id:found.id,name:found.name};localStorage.setItem('usp_user',JSON.stringify(cu));showParent()}
else toast('Invalid','error')
}
}

function showAdmin(){document.getElementById('loginPage').style.display='none';document.getElementById('adminDash').classList.add('active');initAdmin();toast('Welcome Admin!','success')}
function showParent(){document.getElementById('loginPage').style.display='none';document.getElementById('parentDash').classList.add('active');initParent();toast('Welcome!','success');setTimeout(checkFeeReminder,2000);setTimeout(function(){requestNotifPermission();setupFCMListener()},3000)}

function initParent(){
document.getElementById('pNav').innerHTML='<button class="nav-item active" onclick="showP(\'pHome\')"><span>ğŸ </span><span>Home</span></button><button class="nav-item" onclick="showP(\'pResults\');renPRes()"><span>ğŸ“</span><span>Results</span></button><button class="nav-item" onclick="showP(\'pMaterials\');renPMat()"><span>ğŸ“š</span><span>Materials</span></button><button class="nav-item" onclick="showP(\'pLeave\');renPLeave()"><span>âœ‹</span><span>Leave</span></button><button class="nav-item" onclick="showP(\'pFees\')"><span>ğŸ’°</span><span>Fees</span></button>';
document.getElementById('resFilters').innerHTML='<button class="filter-btn active" onclick="setResF(this,\'all\')">All</button><button class="filter-btn" onclick="setResF(this,\'5\')">Last 5</button><button class="filter-btn" onclick="setResF(this,\'10\')">Last 10</button><button class="filter-btn" onclick="setResF(this,\'Mathematics\')">Maths</button><button class="filter-btn" onclick="setResF(this,\'Science\')">Science</button><button class="filter-btn" onclick="setResF(this,\'Social Science\')">Social Science</button>';
document.getElementById('pMatFilters').innerHTML='<button class="filter-btn active" onclick="setMatF(this,\'all\')">All</button><button class="filter-btn" onclick="setMatF(this,\'Mathematics\')">Maths</button><button class="filter-btn" onclick="setMatF(this,\'Science\')">Science</button><button class="filter-btn" onclick="setMatF(this,\'Social Science\')">Social Science</button>';
}

function initAdmin(){
document.getElementById('aNav').innerHTML='<button class="nav-item active" onclick="showA(\'aHome\')"><span>ğŸ </span><span>Home</span></button><button class="nav-item" onclick="showA(\'aAtt\');renAtt()"><span>ğŸ“‹</span><span>Attend</span></button><button class="nav-item" onclick="showA(\'aTests\')"><span>ğŸ“</span><span>Tests</span></button><button class="nav-item" onclick="showA(\'aWorksheets\');renAWs()"><span>ğŸ“š</span><span>Upload</span></button><button class="nav-item" onclick="showA(\'aAnalytics\');renAnalytics()"><span>ğŸ“Š</span><span>Stats</span></button><button class="nav-item" onclick="showA(\'aFees\')"><span>ğŸ’°</span><span>Fees</span></button>';
document.getElementById('quickActions').innerHTML='<button class="action" onclick="openM(\'addSModal\')"><div class="action-icon">â•</div><div class="action-label">Add Student</div></button><button class="action" onclick="showA(\'aAtt\');renAtt()"><div class="action-icon">ğŸ“‹</div><div class="action-label">Attendance</div></button><button class="action" onclick="openM(\'addTModal\')"><div class="action-icon">ğŸ“</div><div class="action-label">Add Test</div></button><button class="action" onclick="showA(\'aAlerts\');renAdminAlerts()"><div class="action-icon">ğŸ””</div><div class="action-label">Alerts</div></button><button class="action" onclick="showA(\'aWorksheets\');renAWs()"><div class="action-icon">ğŸ“š</div><div class="action-label">Materials</div></button><button class="action" onclick="showA(\'aLeave\');renAdminLeave()"><div class="action-icon">âœ‹</div><div class="action-label">Leave Req</div></button>';
document.getElementById('clsFilters').innerHTML='<button class="filter-btn active" onclick="setClsF(this,\'all\')">All</button><button class="filter-btn" onclick="setClsF(this,\'VI\')">VI</button><button class="filter-btn" onclick="setClsF(this,\'VII\')">VII</button><button class="filter-btn" onclick="setClsF(this,\'VIII\')">VIII</button><button class="filter-btn" onclick="setClsF(this,\'IX\')">IX</button><button class="filter-btn" onclick="setClsF(this,\'X\')">X</button>';
document.getElementById('wsFilters').innerHTML='<button class="filter-btn active" onclick="setWsF(this,\'all\')">All</button><button class="filter-btn" onclick="setWsF(this,\'Mathematics\')">Maths</button><button class="filter-btn" onclick="setWsF(this,\'Science\')">Science</button><button class="filter-btn" onclick="setWsF(this,\'Social Science\')">Social Science</button>';
}

function showP(id){document.querySelectorAll('#parentDash .page').forEach(function(p){p.classList.remove('active')});document.getElementById(id).classList.add('active');document.querySelectorAll('#pNav .nav-item').forEach(function(b){b.classList.remove('active')});event.target.closest('.nav-item').classList.add('active')}
function showA(id){document.querySelectorAll('#adminDash .page').forEach(function(p){p.classList.remove('active')});document.getElementById(id).classList.add('active');document.querySelectorAll('#aNav .nav-item').forEach(function(b){b.classList.remove('active')});var navBtn=event&&event.target?event.target.closest('.nav-item'):null;if(navBtn)navBtn.classList.add('active')}

function setClsF(btn,c){document.querySelectorAll('#clsFilters .filter-btn').forEach(function(b){b.classList.remove('active')});btn.classList.add('active');curFilter=c;renStu()}
function setWsF(btn,c){document.querySelectorAll('#wsFilters .filter-btn').forEach(function(b){b.classList.remove('active')});btn.classList.add('active');wsFilter=c;renAWs()}
function setResF(btn,f){document.querySelectorAll('#resFilters .filter-btn').forEach(function(b){b.classList.remove('active')});btn.classList.add('active');resFilter=f;renPRes()}
function setMatF(btn,f){document.querySelectorAll('#pMatFilters .filter-btn').forEach(function(b){b.classList.remove('active')});btn.classList.add('active');matFilter=f;renPMat()}

function render(){if(cu&&cu.role==='admin'){updAdmin();renStu();renTests();renFees();renAWs();ldDD()}if(cu&&cu.role==='parent'){renPHome();renPRes();renPMat();renPFees();updateNotifBadge()}}
// Parent Functions
function renPHome(){
if(!cu||cu.role!=='parent')return;
var s=null;for(var i=0;i<stu.length;i++){if(stu[i].id===cu.id){s=stu[i];break}}
if(!s)return;
// Show photo
if(s.photo){document.getElementById('pPhoto').innerHTML='<img src="'+s.photo+'">'}
else{document.getElementById('pInit').textContent=s.name?s.name.charAt(0):'S'}
document.getElementById('pWelcome').textContent='Welcome, '+(s.name||'');
// Stats
var pres=0;for(var i=0;i<att.length;i++){if(att[i].sid===cu.id&&att[i].status==='present')pres++}
document.getElementById('pAttDays').textContent=pres;
var totalAtt=att.filter(function(a){return a.sid===cu.id}).length;
var attPct=totalAtt>0?Math.round((pres/totalAtt)*100):0;
document.getElementById('pAttPct').textContent=attPct+'%';
var myRes=[],avgPct=0;
for(var i=0;i<res.length;i++){if(res[i].sid===cu.id)myRes.push(res[i])}
if(myRes.length){var t=0;for(var i=0;i<myRes.length;i++){var test=null;for(var j=0;j<tst.length;j++){if(tst[j].id===myRes[i].tid){test=tst[j];break}}if(test)t+=Math.round((myRes[i].marks/test.totalMarks)*100)}avgPct=Math.round(t/myRes.length)}
document.getElementById('pAvgPct').textContent=avgPct+'%';
document.getElementById('pTestCnt').textContent=myRes.length;
var rankInfo=calculateRank(cu.id);
document.getElementById('pRank').textContent='#'+rankInfo.rank;
document.getElementById('pClassAvg').textContent=rankInfo.classAvg+'%';
renderParentBadges();
// Alerts
var myAlerts=[];for(var i=0;i<alerts.length;i++){if(alerts[i].sid===cu.id||alerts[i].sid==='ALL')myAlerts.push(alerts[i])}
myAlerts.sort(function(a,b){return(b.time||0)-(a.time||0)});
myAlerts=myAlerts.slice(0,5);
var html='';
for(var i=0;i<myAlerts.length;i++){
var type=getAlertType(myAlerts[i].msg);
html+='<div class="alert-card '+(type==='positive'?'positive':'')+'"><div style="font-size:12px;font-weight:600">'+myAlerts[i].msg+'</div><div style="font-size:10px;color:#888;margin-top:4px">'+formatDate(myAlerts[i].time)+'</div></div>';
}
document.getElementById('notifList').innerHTML=html||'<div class="empty">No alerts</div>';
}

function renPRes(){
if(!cu||cu.role!=='parent')return;
var s=null;for(var i=0;i<stu.length;i++){if(stu[i].id===cu.id){s=stu[i];break}}
if(!s)return;
var myRes=[];
for(var i=0;i<res.length;i++){
if(res[i].sid===cu.id){
var t=null;for(var j=0;j<tst.length;j++){if(tst[j].id===res[i].tid){t=tst[j];break}}
if(t)myRes.push({marks:res[i].marks,test:t})
}
}
myRes.sort(function(a,b){return(b.test.createdAt||0)-(a.test.createdAt||0)});
// Apply filter
if(resFilter==='5')myRes=myRes.slice(0,5);
else if(resFilter==='10')myRes=myRes.slice(0,10);
else if(resFilter==='Mathematics'||resFilter==='Science'||resFilter==='Social Science'){
myRes=myRes.filter(function(r){return r.test.subject===resFilter});
}
// Render results
var html='';
for(var i=0;i<myRes.length;i++){
var r=myRes[i],pct=Math.round((r.marks/r.test.totalMarks)*100),g=getGrade(pct);
html+='<div class="result-card"><div class="score-circle" style="background:'+g.c+'">'+g.g+'</div><div class="card-info"><div class="card-title">'+r.test.name+' - '+pct+'%</div><div class="card-sub">'+r.marks+'/'+r.test.totalMarks+' â€¢ '+r.test.subject+' â€¢ '+formatDate(r.test.date)+'</div></div></div>';
}
document.getElementById('resultsList').innerHTML=html||'<div class="empty">No results found</div>';
// Render charts
renderBarChart(myRes);
renderPieChart(myRes);
}

function renderPieChart(myRes){
var chartBox=document.getElementById('chartBox');
if(myRes.length===0){chartBox.style.display='none';return}
chartBox.style.display='block';
var subjects={};
for(var i=0;i<myRes.length;i++){
var subj=myRes[i].test.subject,pct=Math.round((myRes[i].marks/myRes[i].test.totalMarks)*100);
if(!subjects[subj])subjects[subj]={total:0,cnt:0};
subjects[subj].total+=pct;subjects[subj].cnt++;
}
var labels=Object.keys(subjects);
var data=labels.map(function(s){return Math.round(subjects[s].total/subjects[s].cnt)});
if(pieChart)pieChart.destroy();
pieChart=new Chart(document.getElementById('pieChart'),{
type:'doughnut',
data:{labels:labels,datasets:[{data:data,backgroundColor:['#1a365d','#48bb78','#ed8936','#e53e3e','#667eea']}]},
options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}
});
}

function renPMat(){
if(!cu||cu.role!=='parent')return;
var s=null;for(var i=0;i<stu.length;i++){if(stu[i].id===cu.id){s=stu[i];break}}
if(!s)return;
var myWs=worksheets.filter(function(w){return w.class===s.class||w.class==='ALL'});
if(matFilter!=='all')myWs=myWs.filter(function(w){return w.subject===matFilter});
myWs.sort(function(a,b){return(b.createdAt||0)-(a.createdAt||0)});
var html='';
for(var i=0;i<myWs.length;i++){
var w=myWs[i];
html+='<div class="card" data-url="'+w.url+'" onclick="openFile(this)"><div class="avatar" style="background:#667eea">ğŸ“„</div><div class="card-info"><div class="card-title">'+w.title+'</div><div class="card-sub">'+w.subject+' â€¢ '+formatDate(w.createdAt)+'</div></div><button class="btn-small" style="background:#25D366">ğŸ“¥</button></div>';
}
document.getElementById('pMatList').innerHTML=html||'<div class="empty">No materials available</div>';
}

function downloadWs(url){
if(!url){toast('File not found','error');return}
window.open(url,'_blank');
}

function openFile(el){
var url=el.getAttribute('data-url');
if(url&&url!=='undefined'&&url!=='null'&&url!==''){
if(url.startsWith('data:')){
// For base64 data, create blob and open
var arr=url.split(','),mime=arr[0].match(/:(.*?);/)[1],bstr=atob(arr[1]),n=bstr.length,u8arr=new Uint8Array(n);
while(n--){u8arr[n]=bstr.charCodeAt(n)}
var blob=new Blob([u8arr],{type:mime});
var blobUrl=URL.createObjectURL(blob);
window.open(blobUrl,'_blank');
}else{
window.open(url,'_blank');
}
}else{
toast('File not available','error');
}
}

function renPAlerts(){
if(!cu||cu.role!=='parent')return;
var lastSeen=parseInt(localStorage.getItem('usp_lastSeen_'+cu.id)||'0');
var myAlerts=alerts.filter(function(a){return a.sid===cu.id||a.sid==='ALL'});
myAlerts.sort(function(a,b){return(b.time||0)-(a.time||0)});
var html='';
for(var i=0;i<myAlerts.length;i++){
var a=myAlerts[i],type=getAlertType(a.msg);
var isUnread=(a.time||0)>lastSeen;
var cls=type==='positive'?'positive':type==='info'?'info':'';
if(isUnread)cls+=' notif-unread';
html+='<div class="alert-card '+cls+'"><div style="font-size:12px;font-weight:600">'+(isUnread?'ğŸ”´ ':'')+a.msg+'</div><div style="font-size:10px;color:#888;margin-top:4px">'+formatDate(a.time)+'</div></div>';
}
document.getElementById('pAlertsList').innerHTML=html||'<div class="empty">No alerts</div>';
}

function renPFees(){
if(!cu||cu.role!=='parent')return;
var s=null;for(var i=0;i<stu.length;i++){if(stu[i].id===cu.id){s=stu[i];break}}
if(!s)return;
var myFee=[],paid=0;
for(var i=0;i<fee.length;i++){if(fee[i].sid===cu.id){myFee.push(fee[i]);paid+=fee[i].amount}}
var join=new Date(s.joinDate||td),now=new Date();
var months=Math.max(1,(now.getFullYear()-join.getFullYear())*12+(now.getMonth()-join.getMonth())+1);
var due=(s.fee||500)*months,pending=Math.max(0,due-paid);
document.getElementById('feePend').textContent='â‚¹'+pending;
document.getElementById('feeStat').textContent=pending>0?'âš ï¸ Due':'âœ… Clear';
myFee.sort(function(a,b){return new Date(b.date)-new Date(a.date)});
var html='';
for(var i=0;i<myFee.length;i++){html+='<div class="card"><div class="avatar" style="background:#d4fc79;color:#333">ğŸ’°</div><div class="card-info"><div class="card-title">â‚¹'+myFee[i].amount+'</div><div class="card-sub">'+formatDate(myFee[i].date)+(myFee[i].remark?' â€¢ '+myFee[i].remark:'')+'</div></div><button class="btn-small" style="background:#25D366" onclick="genReceipt(\''+myFee[i].id+'\');">ğŸ§¾</button></div>'}
document.getElementById('feeList').innerHTML=html||'<div class="empty">No payments</div>';
}
// PDF Functions - Exact layout like sample
function viewReport(){
var s=null;for(var i=0;i<stu.length;i++){if(stu[i].id===cu.id){s=stu[i];break}}
if(!s)return;
var myRes=[];
for(var i=0;i<res.length;i++){
if(res[i].sid===cu.id){
var t=null;for(var j=0;j<tst.length;j++){if(tst[j].id===res[i].tid){t=tst[j];break}}
if(t)myRes.push({marks:res[i].marks,test:t})
}
}
if(!myRes.length)return toast('No results','error');
myRes.sort(function(a,b){return(b.test.createdAt||0)-(a.test.createdAt||0)});
// Apply current filter
if(resFilter==='5')myRes=myRes.slice(0,5);
else if(resFilter==='10')myRes=myRes.slice(0,10);
else if(resFilter==='Mathematics'||resFilter==='Science'||resFilter==='Social Science'){
myRes=myRes.filter(function(r){return r.test.subject===resFilter});
}
if(!myRes.length)return toast('No results for this filter','error');

var totalMarks=0,totalMax=0;
for(var i=0;i<myRes.length;i++){totalMarks+=myRes[i].marks;totalMax+=myRes[i].test.totalMarks}
var avgPct=Math.round((totalMarks/totalMax)*100),overall=getGrade(avgPct);
var subjects={};
for(var i=0;i<myRes.length;i++){
var subj=myRes[i].test.subject,pct=Math.round((myRes[i].marks/myRes[i].test.totalMarks)*100);
if(!subjects[subj])subjects[subj]={total:0,cnt:0};
subjects[subj].total+=pct;subjects[subj].cnt++;
}

var jsPDF=window.jspdf.jsPDF,doc=new jsPDF();
// Header - Dark blue
doc.setFillColor(26,53,93);doc.rect(0,0,210,42,'F');
// Orange circle with U
doc.setFillColor(237,137,54);doc.roundedRect(18,12,30,20,3,3,'F');
doc.setTextColor(255);doc.setFontSize(14);doc.setFont('helvetica','bold');
doc.text('USP',33,25,{align:'center'});
// Title
doc.setFontSize(18);doc.text('UNIQUE STUDY POINT',105,18,{align:'center'});
doc.setFontSize(9);doc.setFont('helvetica','normal');
doc.text('By Sumeet Sahu | Excellence in Education',105,26,{align:'center'});
doc.text('Amitesh Nagar, Indore, M.P. | www.uniquestudyonline.com',105,34,{align:'center'});
// Orange bar
doc.setFillColor(237,137,54);doc.rect(0,42,210,11,'F');
doc.setFontSize(11);doc.setFont('helvetica','bold');
doc.text('MONTHLY PROGRESS REPORT - '+getMonth().toUpperCase(),105,49,{align:'center'});

// Student info box - FIX 1: Remove subjects from header, move to separate line
doc.setDrawColor(26,53,93);doc.setLineWidth(0.5);
doc.roundedRect(14,58,182,20,2,2,'S');
doc.setTextColor(26,53,93);doc.setFontSize(9);doc.setFont('helvetica','bold');
doc.text('Student Name:',18,66);doc.text('Class:',85,66);doc.text('Roll No:',130,66);doc.text('Date:',170,66);
doc.setFont('helvetica','normal');doc.setTextColor(0);
doc.text(s.name||'',48,66);doc.text(s.class||'',100,66);doc.text(s.userId||'',150,66);doc.text(formatDate(Date.now()),182,66);

// Table - FIX 1: Add Subject column
var tableData=[];
for(var i=0;i<myRes.length;i++){
var r=myRes[i],pct=Math.round((r.marks/r.test.totalMarks)*100),g=getGrade(pct);
tableData.push([r.test.name,r.test.subject,formatDate(r.test.date),r.marks+'/'+r.test.totalMarks,pct+'%',g.g]);
}
doc.autoTable({
startY:82,
head:[['Test Name','Subject','Date','Marks','%','Grade']],
body:tableData,
theme:'grid',
headStyles:{fillColor:[26,53,93],textColor:255,fontSize:8,fontStyle:'bold'},
bodyStyles:{fontSize:8,textColor:80},
columnStyles:{0:{cellWidth:40},1:{cellWidth:30},2:{cellWidth:25},3:{cellWidth:22},4:{cellWidth:18},5:{cellWidth:15}}
});

var y=doc.lastAutoTable.finalY+6;
// Performance Summary
doc.setFillColor(26,53,93);doc.roundedRect(14,y,182,14,2,2,'F');
doc.setTextColor(255);doc.setFontSize(8);doc.setFont('helvetica','bold');
doc.text('PERFORMANCE SUMMARY',105,y+5,{align:'center'});
doc.setFont('helvetica','normal');
doc.text('Tests: '+myRes.length,30,y+11);
doc.text('Marks: '+totalMarks+'/'+totalMax,70,y+11);
doc.text('Average: '+avgPct+'%',120,y+11);
doc.text('Grade: '+overall.g,165,y+11);

y+=20;
// FIX 2: Subject-wise Performance - Show ALL subjects properly
doc.setTextColor(26,53,93);doc.setFontSize(9);doc.setFont('helvetica','bold');
doc.text('Subject-wise Performance:',14,y);
y+=6;
var subKeys=Object.keys(subjects);
var boxW=Math.min(55,180/Math.max(subKeys.length,1)-2);
var startX=14;
doc.setFillColor(72,187,120);
for(var i=0;i<subKeys.length;i++){
var avg=Math.round(subjects[subKeys[i]].total/subjects[subKeys[i]].cnt);
var boxColor=avg>=80?[39,174,96]:avg>=60?[52,152,219]:avg>=40?[241,196,15]:[231,76,60];
doc.setFillColor(boxColor[0],boxColor[1],boxColor[2]);
doc.roundedRect(startX,y,boxW,10,2,2,'F');
doc.setTextColor(255);doc.setFontSize(7);
doc.text(subKeys[i].substring(0,8)+': '+avg+'%',startX+boxW/2,y+7,{align:'center'});
startX+=boxW+3;
}

y+=16;
// FIX 3: Subject-wise Remarks (detailed)
doc.setFillColor(255,250,235);doc.setDrawColor(237,137,54);doc.setLineWidth(0.5);
var remarkHeight=8+subKeys.length*6;
doc.roundedRect(14,y,182,remarkHeight,2,2,'FD');
doc.setTextColor(26,53,93);doc.setFontSize(9);doc.setFont('helvetica','bold');
doc.text("Teacher's Remarks:",18,y+6);
doc.setFont('helvetica','normal');doc.setTextColor(0);doc.setFontSize(7);
var ry=y+12;
for(var i=0;i<subKeys.length;i++){
var avg=Math.round(subjects[subKeys[i]].total/subjects[subKeys[i]].cnt);
var rem=avg>=90?'Outstanding!':avg>=80?'Excellent work!':avg>=70?'Very good progress.':avg>=60?'Good effort, keep improving.':avg>=50?'Average, needs more practice.':avg>=40?'Below average, needs attention.':'Needs significant improvement.';
doc.text(subKeys[i]+': '+rem,20,ry);
ry+=5;
}

y+=remarkHeight+6;
// FIX 4: Add Line Chart to PDF
if(myRes.length>1){
doc.setTextColor(26,53,93);doc.setFontSize(9);doc.setFont('helvetica','bold');
doc.text('Performance Trend:',14,y);
y+=4;
// Draw simple line chart
var chartW=170,chartH=30,chartX=20,chartY=y;
doc.setDrawColor(200);doc.setLineWidth(0.2);
doc.rect(chartX,chartY,chartW,chartH);
// Draw grid lines
for(var g=0;g<=4;g++){
var gy=chartY+(chartH/4)*g;
doc.line(chartX,gy,chartX+chartW,gy);
}
// Plot data points
var pts=myRes.slice(0,10).reverse();
var stepX=chartW/(pts.length-1||1);
doc.setDrawColor(102,126,234);doc.setLineWidth(1);
for(var i=1;i<pts.length;i++){
var p1=Math.round((pts[i-1].marks/pts[i-1].test.totalMarks)*100);
var p2=Math.round((pts[i].marks/pts[i].test.totalMarks)*100);
var x1=chartX+(i-1)*stepX,y1=chartY+chartH-(p1/100)*chartH;
var x2=chartX+i*stepX,y2=chartY+chartH-(p2/100)*chartH;
doc.line(x1,y1,x2,y2);
doc.setFillColor(102,126,234);doc.circle(x1,y1,1.5,'F');
if(i===pts.length-1)doc.circle(x2,y2,1.5,'F');
}
// Labels
doc.setFontSize(6);doc.setTextColor(100);
doc.text('100%',chartX-8,chartY+3);doc.text('0%',chartX-6,chartY+chartH);
y+=chartH+8;
}

// Footer - adjust position based on content
var footerY=Math.max(y+10,275);
if(footerY>285)footerY=285;
doc.setFillColor(26,53,93);doc.rect(0,footerY,210,17,'F');
doc.setTextColor(255);doc.setFontSize(7);
doc.text('This is a computer generated report from UNIQUE STUDY POINT',105,footerY+6,{align:'center'});
doc.text('www.uniquestudyonline.com | Contact: '+PHONE,105,footerY+12,{align:'center'});

doc.save(s.name+'_Report_'+getMonth().replace(' ','_')+'.pdf');
toast('Downloaded!','success');
}

function downloadAlertPDF(){
var s=null;for(var i=0;i<stu.length;i++){if(stu[i].id===cu.id){s=stu[i];break}}
if(!s)return;
var myAlerts=alerts.filter(function(a){return a.sid===cu.id||a.sid==='ALL'});
if(!myAlerts.length)return toast('No alerts','error');
myAlerts.sort(function(a,b){return(b.time||0)-(a.time||0)});

var jsPDF=window.jspdf.jsPDF,doc=new jsPDF();
// Header
doc.setFillColor(26,53,93);doc.rect(0,0,210,42,'F');
doc.setFillColor(237,137,54);doc.roundedRect(18,12,30,20,3,3,'F');
doc.setTextColor(255);doc.setFontSize(12);doc.setFont('helvetica','bold');
doc.text('USP',33,25,{align:'center'});
doc.setFontSize(18);doc.text('UNIQUE STUDY POINT',115,18,{align:'center'});
doc.setFontSize(9);doc.setFont('helvetica','normal');
doc.text('By Sumeet Sahu | www.uniquestudyonline.com',105,28,{align:'center'});
doc.setFillColor(237,137,54);doc.rect(0,42,210,11,'F');
doc.setFontSize(11);doc.setFont('helvetica','bold');
doc.text('ALERT REPORT - '+s.name,105,49,{align:'center'});

var tableData=[];
for(var i=0;i<myAlerts.length;i++){tableData.push([i+1,formatDate(myAlerts[i].time),myAlerts[i].msg,getAlertType(myAlerts[i].msg).toUpperCase()])}
doc.autoTable({startY:58,head:[['#','Date','Message','Type']],body:tableData,theme:'grid',headStyles:{fillColor:[26,53,93]},columnStyles:{2:{cellWidth:90}}});

doc.setFillColor(26,53,93);doc.rect(0,280,210,17,'F');
doc.setTextColor(255);doc.setFontSize(7);
doc.text('www.uniquestudyonline.com | Contact: '+PHONE,105,290,{align:'center'});
doc.save(s.name+'_Alerts.pdf');toast('Downloaded!','success');
}

function downloadAttPDF(){
var month=document.getElementById('attMonth').value;
if(!month)return toast('Select month','error');
var monthName=new Date(month+'-01').toLocaleDateString('en-IN',{month:'long',year:'numeric'});
var monthAtt=att.filter(function(a){return a.date&&a.date.startsWith(month)});
var stuData={};
for(var i=0;i<stu.length;i++){stuData[stu[i].id]={name:stu[i].name,class:stu[i].class,present:0,absent:0,presentDates:[],absentDates:[]}}
for(var i=0;i<monthAtt.length;i++){var a=monthAtt[i];if(stuData[a.sid]){if(a.status==='present'){stuData[a.sid].present++;stuData[a.sid].presentDates.push(new Date(a.date).getDate())}else{stuData[a.sid].absent++;stuData[a.sid].absentDates.push(new Date(a.date).getDate())}}}

var jsPDF=window.jspdf.jsPDF,doc=new jsPDF();
doc.setFillColor(26,53,93);doc.rect(0,0,210,42,'F');
doc.setFillColor(237,137,54);doc.roundedRect(18,12,30,20,3,3,'F');
doc.setTextColor(255);doc.setFontSize(12);doc.setFont('helvetica','bold');
doc.text('USP',33,25,{align:'center'});
doc.setFontSize(18);doc.text('UNIQUE STUDY POINT',115,18,{align:'center'});
doc.setFontSize(9);doc.setFont('helvetica','normal');
doc.text('By Sumeet Sahu | www.uniquestudyonline.com',115,28,{align:'center'});
doc.setFillColor(237,137,54);doc.rect(0,42,210,11,'F');
doc.setFontSize(11);doc.setFont('helvetica','bold');
doc.text('MONTHLY ATTENDANCE REPORT - '+monthName.toUpperCase(),105,49,{align:'center'});

var tableData=[];var keys=Object.keys(stuData);
for(var i=0;i<keys.length;i++){
var d=stuData[keys[i]],total=d.present+d.absent,pct=total>0?Math.round((d.present/total)*100):0;
var remark=pct>=90?'Excellent':pct>=75?'Good':pct>=50?'Average':'Poor';
var pDates=d.presentDates.sort(function(a,b){return a-b}).join(',');
var aDates=d.absentDates.sort(function(a,b){return a-b}).join(',');
tableData.push([i+1,d.name,d.class,d.present+'\n('+pDates+')',d.absent+'\n('+(aDates||'-')+')',pct+'%',remark]);
}
doc.autoTable({startY:58,head:[['#','Name','Class','Present (Dates)','Absent (Dates)','%','Remark']],body:tableData,theme:'grid',headStyles:{fillColor:[26,53,93],fontSize:8},bodyStyles:{fontSize:7},columnStyles:{3:{cellWidth:35},4:{cellWidth:35}}});

doc.setFillColor(26,53,93);doc.rect(0,280,210,17,'F');
doc.setTextColor(255);doc.setFontSize(7);
doc.text('www.uniquestudyonline.com | Contact: '+PHONE,105,290,{align:'center'});
doc.save('Attendance_'+monthName.replace(' ','_')+'.pdf');toast('Downloaded!','success');
}
// Admin Functions
function updAdmin(){
document.getElementById('aStu').textContent=stu.length;
document.getElementById('aTst').textContent=tst.length;
var p=0;for(var i=0;i<att.length;i++){if(att[i].date===td&&att[i].status==='present')p++}
document.getElementById('aPre').textContent=p;
}

function renStu(){
var f=curFilter==='all'?stu:stu.filter(function(s){return s.class===curFilter});
var html='';
for(var i=0;i<f.length;i++){
var s=f[i],av=s.photo?'<img src="'+s.photo+'">':s.name.charAt(0);
html+='<div class="card"><div class="avatar">'+av+'</div><div class="card-info"><div class="card-title">'+s.name+'</div><div class="card-sub">Class '+s.class+' â€¢ '+s.mobile+'</div></div><div style="display:flex;gap:5px"><button class="btn-small" style="background:#25D366" onclick="genPTMReport(\''+s.id+'\')">ğŸ“„</button><button class="btn-small" style="background:#667eea" onclick="openEditS(\''+s.id+'\')">âœï¸</button><button class="btn-small btn-del" onclick="quickDel(\''+s.id+'\',\''+s.name+'\')">ğŸ—‘ï¸</button></div></div>';
}
document.getElementById('aList').innerHTML=html||'<div class="empty">No students</div>';
}

function quickDel(id,name){
if(confirm('Delete '+name+'?')){
db.ref('students/'+id).remove();
['attendance','results','fees','alerts'].forEach(function(path){
db.ref(path).orderByChild('sid').equalTo(id).once('value',function(s){
s.forEach(function(c){db.ref(path+'/'+c.key).remove()})
})
});
toast('Deleted!','success');
}
}

function openEditS(id){
var s=null;for(var i=0;i<stu.length;i++){if(stu[i].id===id){s=stu[i];break}}
if(!s)return;
document.getElementById('editSId').value=s.id;
document.getElementById('editSN').value=s.name;
document.getElementById('editSC').value=s.class;
document.getElementById('editSM').value=s.mobile;
document.getElementById('editSM2').value=s.mobile2||'';
document.getElementById('editSM3').value=s.mobile3||'';
document.getElementById('editSU').value=s.userId;
document.getElementById('editSP').value=s.password;
document.getElementById('editSFee').value=s.fee||500;
document.getElementById('editSJoin').value=s.joinDate||td;
editPhotoUrl=s.photo||'';
document.getElementById('editPhotoBox').innerHTML=s.photo?'<img src="'+s.photo+'">':'<span style="font-size:28px">ğŸ“·</span>';
openM('editSModal');
}

function saveS(){
var n=document.getElementById('sN').value.trim(),c=document.getElementById('sC').value,m=document.getElementById('sM').value.trim(),m2=document.getElementById('sM2').value.trim(),m3=document.getElementById('sM3').value.trim(),u=document.getElementById('sU').value.trim(),p=document.getElementById('sP').value.trim(),f=document.getElementById('sFee').value,j=document.getElementById('sJoin').value,dob=document.getElementById('sDOB').value;
if(!n||!c||!m||!u||!p)return toast('Fill all fields','error');
if(m.length!==10)return toast('Mobile 1: 10 digits','error');
if(m2&&m2.length!==10)return toast('Mobile 2: 10 digits','error');
if(m3&&m3.length!==10)return toast('Mobile 3: 10 digits','error');
db.ref('students').push({name:n,class:c,mobile:m,mobile2:m2||'',mobile3:m3||'',userId:u,password:p,fee:parseInt(f)||500,joinDate:j,dob:dob||'',photo:addPhotoUrl}).then(function(){
closeM('addSModal');
document.getElementById('sN').value='';document.getElementById('sC').value='';document.getElementById('sM').value='';document.getElementById('sM2').value='';document.getElementById('sM3').value='';document.getElementById('sU').value='';document.getElementById('sP').value='';
addPhotoUrl='';document.getElementById('addPhotoBox').innerHTML='<span style="font-size:28px">ğŸ“·</span>';
toast('Added!','success');
});
}

function updateS(){
var id=document.getElementById('editSId').value,n=document.getElementById('editSN').value.trim(),c=document.getElementById('editSC').value,m=document.getElementById('editSM').value.trim(),m2=document.getElementById('editSM2').value.trim(),m3=document.getElementById('editSM3').value.trim(),u=document.getElementById('editSU').value.trim(),p=document.getElementById('editSP').value.trim(),f=document.getElementById('editSFee').value,j=document.getElementById('editSJoin').value,dob=document.getElementById('editSDOB').value;
if(!n||!c||!m||!u||!p)return toast('Fill all','error');
db.ref('students/'+id).update({name:n,class:c,mobile:m,mobile2:m2||'',mobile3:m3||'',userId:u,password:p,fee:parseInt(f)||500,joinDate:j,dob:dob||'',photo:editPhotoUrl}).then(function(){closeM('editSModal');toast('Updated!','success')});
}

function deleteS(){
var id=document.getElementById('editSId').value,name=document.getElementById('editSN').value;
quickDel(id,name);closeM('editSModal');
}

function renAtt(){
var d=document.getElementById('attD').value||td,html='';
for(var i=0;i<stu.length;i++){
var s=stu[i],a=null;
for(var j=0;j<att.length;j++){if(att[j].sid===s.id&&att[j].date===d){a=att[j];break}}
var st=a?a.status:'',av=s.photo?'<img src="'+s.photo+'">':s.name.charAt(0);
html+='<div class="card"><div class="avatar">'+av+'</div><div class="card-info"><div class="card-title">'+s.name+'</div><div class="card-sub">'+s.class+'</div></div><div style="display:flex;gap:5px"><button class="btn-small" style="background:'+(st==='present'?'#25D366':'#e8e8e8')+';color:'+(st==='present'?'#fff':'#333')+'" onclick="mAtt(\''+s.id+'\',\'present\',this)">âœ“</button><button class="btn-small" style="background:'+(st==='absent'?'#ff6b6b':'#e8e8e8')+';color:'+(st==='absent'?'#fff':'#333')+'" onclick="mAtt(\''+s.id+'\',\'absent\',this)">âœ—</button><button class="btn-small" style="background:#667eea" onclick="sendIndAttSMS(\''+s.id+'\')">ğŸ“±</button></div></div>';
}
document.getElementById('attL').innerHTML=html||'<div class="empty">No students</div>';
}

function mAtt(sid,st,btn){
var d=document.getElementById('attD').value||td,ex=null;
for(var i=0;i<att.length;i++){if(att[i].sid===sid&&att[i].date===d){ex=att[i];break}}
if(ex)db.ref('attendance/'+ex.id).update({status:st});
else db.ref('attendance').push({sid:sid,date:d,status:st});
var sibs=btn.parentElement.querySelectorAll('.btn-small');
for(var i=0;i<sibs.length;i++){sibs[i].style.background='#e8e8e8';sibs[i].style.color='#333'}
btn.style.background=st==='present'?'#25D366':'#ff6b6b';btn.style.color='#fff';
toast('Marked!','success');
}

function getAllMobiles(s){
var nums=[s.mobile];
if(s.mobile2)nums.push(s.mobile2);
if(s.mobile3)nums.push(s.mobile3);
return nums;
}

function sendAttSMS(){
var d=document.getElementById('attD').value||td,absent=[];
for(var i=0;i<stu.length;i++){
for(var j=0;j<att.length;j++){
if(att[j].sid===stu[i].id&&att[j].date===d&&att[j].status==='absent'){absent.push(stu[i]);break}
}
}
if(absent.length){
var nums=[];absent.forEach(function(s){getAllMobiles(s).forEach(function(n){nums.push(n)})});nums=nums.join(',');
fetch('https://www.fast2sms.com/dev/bulkV2?authorization=P3WtxzoqRgB58mSnZ1vJAwGQ2p7UTY0ci6dLjlhbkDCf4auKHI2qKczUL1AMVRj6WSDItJekFaZxP8no&route=q&message='+encodeURIComponent('UNIQUE STUDY POINT: Your ward was ABSENT on '+formatDate(d)+'. -Sumeet Sahu, '+PHONE)+'&flash=0&numbers='+nums,{method:'GET',mode:'no-cors'});
toast('SMS Sent!','success');
}else toast('No absent','error');
}

function sendAttWA(){
var d=document.getElementById('attD').value||td,idx=0;
for(var i=0;i<stu.length;i++){
var s=stu[i],a=null;
for(var j=0;j<att.length;j++){if(att[j].sid===s.id&&att[j].date===d){a=att[j];break}}
if(a){
var status=a.status==='present'?'PRESENT âœ…':'ABSENT âŒ';
(function(delay,stud,stat){
setTimeout(function(){window.open('https://wa.me/91'+stud.mobile+'?text='+encodeURIComponent('UNIQUE STUDY POINT\n'+stud.name+'\n'+formatDate(d)+': '+stat+'\n-Sumeet Sahu, '+PHONE),'_blank')},delay*1500);
})(idx,s,status);idx++;
}
}
if(idx)toast('Opening WA...','success');else toast('No attendance','error');
}

function renFees(){
var sorted=fee.slice().sort(function(a,b){return new Date(b.date)-new Date(a.date)});
var html='';
for(var i=0;i<sorted.length;i++){
var f=sorted[i],s=null;
for(var j=0;j<stu.length;j++){if(stu[j].id===f.sid){s=stu[j];break}}
if(s)html+='<div class="card"><div class="avatar">ğŸ’°</div><div class="card-info"><div class="card-title">'+s.name+'</div><div class="card-sub">â‚¹'+f.amount+' â€¢ '+formatDate(f.date)+(f.remark?' â€¢ '+f.remark:'')+'</div></div><button class="btn-small" style="background:#25D366" onclick="genReceipt(\''+f.id+'\')">ğŸ§¾</button><button class="btn-small" style="background:#667eea;margin-left:5px" onclick="openEditF(\''+f.id+'\')">âœï¸</button></div>';
}
document.getElementById('feeL').innerHTML=html||'<div class="empty">No payments</div>';
}

function ldDD(){
var opts='<option value="">Select</option><option value="ALL">ğŸ“¢ ALL STUDENTS</option>';
for(var i=0;i<stu.length;i++){opts+='<option value="'+stu[i].id+'">'+stu[i].name+' ('+stu[i].class+')</option>'}
document.getElementById('alertStu').innerHTML=opts;
var fOpts='<option value="">Select</option>';
for(var i=0;i<stu.length;i++){fOpts+='<option value="'+stu[i].id+'">'+stu[i].name+'</option>'}
document.getElementById('fStu').innerHTML=fOpts;
}

function saveF(){
var sid=document.getElementById('fStu').value,amt=document.getElementById('fAmt').value,d=document.getElementById('fDate').value,rem=document.getElementById('fRemark').value;
if(!sid||!amt)return toast('Fill all','error');
var s=stu.find(function(x){return x.id===sid});
db.ref('fees').push({sid:sid,amount:parseInt(amt),date:d,remark:rem}).then(function(){
// Send fee received alert to parent
var msg='Fee Received: Rs.'+amt+'/- on '+formatDate(d)+(rem?' ('+rem+')':'')+'. Thank you! - UNIQUE STUDY POINT';
db.ref('alerts').push({sid:sid,msg:msg,time:Date.now(),type:'positive'});
closeM('addFModal');document.getElementById('fAmt').value='';document.getElementById('fRemark').value='';toast('Saved & Alert Sent!','success');
});
}

function sendAlertSMS(){
var sid=document.getElementById('alertStu').value,msg=document.getElementById('alertMsg').value.trim();
if(!sid)return toast('Select student','error');
if(!msg)return toast('Enter message','error');
if(sid==='ALL'){
var nums=[];stu.forEach(function(s){getAllMobiles(s).forEach(function(n){nums.push(n)})});nums=nums.join(',');
fetch('https://www.fast2sms.com/dev/bulkV2?authorization=P3WtxzoqRgB58mSnZ1vJAwGQ2p7UTY0ci6dLjlhbkDCf4auKHI2qKczUL1AMVRj6WSDItJekFaZxP8no&route=q&message='+encodeURIComponent('UNIQUE STUDY POINT: '+msg+' -Sumeet Sahu, '+PHONE)+'&flash=0&numbers='+nums,{method:'GET',mode:'no-cors'});
db.ref('alerts').push({sid:'ALL',msg:msg,time:Date.now()});
}else{
var s=null;for(var i=0;i<stu.length;i++){if(stu[i].id===sid){s=stu[i];break}}
if(s){
fetch('https://www.fast2sms.com/dev/bulkV2?authorization=P3WtxzoqRgB58mSnZ1vJAwGQ2p7UTY0ci6dLjlhbkDCf4auKHI2qKczUL1AMVRj6WSDItJekFaZxP8no&route=q&message='+encodeURIComponent('UNIQUE STUDY POINT: '+s.name+' '+msg+' -Sumeet Sahu, '+PHONE)+'&flash=0&numbers='+s.mobile,{method:'GET',mode:'no-cors'});
db.ref('alerts').push({sid:sid,msg:s.name+' '+msg,time:Date.now()});
}
}
closeM('alertModal');document.getElementById('alertMsg').value='';toast('Sent!','success');
}

function sendAlertWA(){
var sid=document.getElementById('alertStu').value,msg=document.getElementById('alertMsg').value.trim();
if(!sid)return toast('Select student','error');
if(!msg)return toast('Enter message','error');
if(sid==='ALL'){
var idx=0;
for(var i=0;i<stu.length;i++){
(function(delay,s){
setTimeout(function(){window.open('https://wa.me/91'+s.mobile+'?text='+encodeURIComponent('UNIQUE STUDY POINT\n\n'+msg+'\n\n-Sumeet Sahu, '+PHONE),'_blank')},delay*1500);
})(idx,stu[i]);idx++;
}
db.ref('alerts').push({sid:'ALL',msg:msg,time:Date.now()});
}else{
var s=null;for(var i=0;i<stu.length;i++){if(stu[i].id===sid){s=stu[i];break}}
if(s){
window.open('https://wa.me/91'+s.mobile+'?text='+encodeURIComponent('UNIQUE STUDY POINT\n\n'+s.name+' '+msg+'\n\n-Sumeet Sahu, '+PHONE),'_blank');
db.ref('alerts').push({sid:sid,msg:s.name+' '+msg,time:Date.now()});
}
}
closeM('alertModal');document.getElementById('alertMsg').value='';toast('Opening WA...','success');
}

function renTests(){
var sorted=tst.slice().sort(function(a,b){return(b.createdAt||0)-(a.createdAt||0)});
var html='';
for(var i=0;i<sorted.length;i++){
var t=sorted[i],cnt=0;
for(var j=0;j<res.length;j++){if(res[j].tid===t.id)cnt++}
html+='<div class="test-card"><div style="font-weight:700;font-size:14px;margin-bottom:4px">'+t.name+'</div><div style="font-size:11px;color:#888;margin-bottom:10px">ğŸ“– '+t.subject+' â€¢ ğŸ“… '+formatDate(t.date)+' â€¢ '+(t.testClass||'All')+' â€¢ '+t.totalMarks+' marks â€¢ '+cnt+' results</div><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn-small" style="background:#667eea" onclick="openMk(\''+t.id+'\')">ğŸ“ Marks</button><button class="btn-small btn-del" onclick="delTest(\''+t.id+'\')">ğŸ—‘ï¸</button></div></div>';
}
document.getElementById('testL').innerHTML=html||'<div class="empty">No tests</div>';
}

function saveT(){
var n=document.getElementById('tN').value.trim(),subj=document.getElementById('tSubj').value,cls=document.getElementById('tClass').value,m=document.getElementById('tM').value,d=document.getElementById('tD').value,notify=document.getElementById('tNotify').value;
if(!n||!subj){toast('Fill name & subject','error');return}
// NO app alert on test creation - alert will go only when marks are entered
var targetStu=cls?stu.filter(function(s){return s.class===cls}):stu;
db.ref('tests').push({name:n,subject:subj,testClass:cls||'All',totalMarks:parseInt(m)||50,date:d,createdAt:Date.now()}).then(function(){
// Only send SMS if notify option selected (no app alert)
if(notify==='all'||notify==='class'){
var nums=[];targetStu.forEach(function(s){getAllMobiles(s).forEach(function(n){nums.push(n)})});nums=nums.join(',');
if(nums)fetch('https://www.fast2sms.com/dev/bulkV2?authorization=P3WtxzoqRgB58mSnZ1vJAwGQ2p7UTY0ci6dLjlhbkDCf4auKHI2qKczUL1AMVRj6WSDItJekFaZxP8no&route=q&message='+encodeURIComponent('UNIQUE STUDY POINT: Test '+n+' ('+subj+')'+(cls?' for Class '+cls:'')+' on '+formatDate(d)+'. -Sumeet Sahu')+'&flash=0&numbers='+nums,{method:'GET',mode:'no-cors'});
}
closeM('addTModal');
document.getElementById('tN').value='';document.getElementById('tSubj').value='';document.getElementById('tClass').value='';document.getElementById('tNotify').value='none';
toast('Test Created!','success');
});
}

function delTest(id){
if(confirm('Delete test and all results?')){
db.ref('tests/'+id).remove();
db.ref('results').orderByChild('tid').equalTo(id).once('value',function(s){s.forEach(function(c){db.ref('results/'+c.key).remove()})});
toast('Deleted!','success');
}
}

function openMk(tid){
ctid=tid;
var t=null;for(var i=0;i<tst.length;i++){if(tst[i].id===tid){t=tst[i];break}}
if(!t)return;
document.getElementById('mkTN').textContent=t.name+' ('+t.totalMarks+')';
var html='';
var testStu=t.testClass&&t.testClass!=='All'?stu.filter(function(s){return s.class===t.testClass}):stu;
for(var i=0;i<testStu.length;i++){
var s=testStu[i],r=null;
for(var j=0;j<res.length;j++){if(res[j].tid===tid&&res[j].sid===s.id){r=res[j];break}}
var av=s.photo?'<img src="'+s.photo+'">':s.name.charAt(0);
var isAbs=r&&r.marks===-1;
html+='<div class="card"><div class="avatar">'+av+'</div><div class="card-info"><div class="card-title">'+s.name+' <small>('+s.class+')</small></div></div><div style="display:flex;gap:5px;align-items:center"><input type="number" id="mk_'+s.id+'" value="'+(r&&r.marks>=0?r.marks:'')+'" placeholder="Marks" style="width:60px;padding:8px;border:2px solid #e8e8e8;border-radius:8px"><button type="button" class="btn-small" id="abs_'+s.id+'" style="background:'+(isAbs?'#ff6b6b':'#e8e8e8')+';color:'+(isAbs?'#fff':'#333')+'" onclick="markAbs(\''+s.id+'\')">AB</button></div></div>';
}
document.getElementById('mkL').innerHTML=html;
openM('addMkModal');
}

function markAbs(sid){
var inp=document.getElementById('mk_'+sid);
var btn=document.getElementById('abs_'+sid);
if(btn.style.background==='rgb(255, 107, 107)'||btn.style.backgroundColor==='rgb(255, 107, 107)'){
btn.style.background='#e8e8e8';
btn.style.color='#333';
inp.value='';
inp.disabled=false;
}else{
btn.style.background='#ff6b6b';
btn.style.color='#fff';
inp.value='-1';
inp.disabled=true;
}
}

function saveMk(){
var t=null;for(var i=0;i<tst.length;i++){if(tst[i].id===ctid){t=tst[i];break}}
var testStu=t&&t.testClass&&t.testClass!=='All'?stu.filter(function(s){return s.class===t.testClass}):stu;
var marksEnteredFor=[];
for(var i=0;i<testStu.length;i++){
var s=testStu[i],inp=document.getElementById('mk_'+s.id);
if(inp&&inp.value!==''&&inp.value!=='-1'){
marksEnteredFor.push(s.id);
var ex=null;
for(var j=0;j<res.length;j++){if(res[j].tid===ctid&&res[j].sid===s.id){ex=res[j];break}}
if(ex)db.ref('results/'+ex.id).update({marks:parseInt(inp.value)});
else db.ref('results').push({tid:ctid,sid:s.id,marks:parseInt(inp.value)});
}
}
// Create alert ONLY for students whose marks were just entered
var t=tst.find(function(x){return x.id===ctid});
if(t&&marksEnteredFor.length>0){
marksEnteredFor.forEach(function(sid){
db.ref('alerts').push({sid:sid,msg:'Results declared for '+t.name+'. Check your results!',time:Date.now(),type:'info'});
});
}
closeM('addMkModal');toast('Marks Saved!','success');
}

function sendMkSMS(){
var t=null;for(var i=0;i<tst.length;i++){if(tst[i].id===ctid){t=tst[i];break}}
if(!t)return;
var nums=[];
for(var i=0;i<stu.length;i++){for(var j=0;j<res.length;j++){if(res[j].tid===ctid&&res[j].sid===stu[i].id){nums.push(stu[i].mobile);break}}}
if(nums.length){
fetch('https://www.fast2sms.com/dev/bulkV2?authorization=P3WtxzoqRgB58mSnZ1vJAwGQ2p7UTY0ci6dLjlhbkDCf4auKHI2qKczUL1AMVRj6WSDItJekFaZxP8no&route=q&message='+encodeURIComponent('UNIQUE STUDY POINT: '+t.name+' results out. -Sumeet Sahu, '+PHONE)+'&flash=0&numbers='+nums.join(','),{method:'GET',mode:'no-cors'});
toast('SMS Sent!','success');
}
}

function sendMkWA(){
var t=null;for(var i=0;i<tst.length;i++){if(tst[i].id===ctid){t=tst[i];break}}
if(!t)return;
var idx=0;
for(var i=0;i<stu.length;i++){
var s=stu[i],r=null;
for(var j=0;j<res.length;j++){if(res[j].tid===ctid&&res[j].sid===s.id){r=res[j];break}}
if(r){
var pct=Math.round((r.marks/t.totalMarks)*100);
(function(d,st,mk,pc){setTimeout(function(){window.open('https://wa.me/91'+st.mobile+'?text='+encodeURIComponent('UNIQUE STUDY POINT\n'+st.name+'\n'+t.name+': '+mk+'/'+t.totalMarks+' ('+pc+'%)\n-Sumeet Sahu, '+PHONE),'_blank')},d*1500)})(idx,s,r.marks,pct);idx++;
}
}
if(idx)toast('Opening WA...','success');
}

function renAWs(){
var f=wsFilter==='all'?worksheets:worksheets.filter(function(w){return w.subject===wsFilter});
f.sort(function(a,b){return(b.createdAt||0)-(a.createdAt||0)});
var html='';
for(var i=0;i<f.length;i++){
var w=f[i];
html+='<div class="ws-card" data-url="'+w.url+'" data-id="'+w.id+'"><div style="font-weight:700;font-size:14px;margin-bottom:4px">'+w.title+'</div><div style="font-size:11px;color:#888;margin-bottom:10px">ğŸ“– '+w.subject+' â€¢ Class '+w.class+' â€¢ '+formatDate(w.createdAt)+'</div><div style="display:flex;gap:8px"><button class="btn-small" style="background:#25D366" onclick="openFile(this.parentElement.parentElement)">ğŸ“¥</button><button class="btn-small btn-del" onclick="delWsById(this.parentElement.parentElement)">ğŸ—‘ï¸</button></div></div>';
}
document.getElementById('aWsList').innerHTML=html||'<div class="empty">No worksheets</div>';
}

function saveWs(){
var cls=document.getElementById('wsClass').value,subj=document.getElementById('wsSubject').value,title=document.getElementById('wsTitle').value.trim(),fileInput=document.getElementById('wsFile');
if(!cls||!subj||!title){toast('Fill all fields','error');return}
if(!fileInput.files.length){toast('Select file','error');return}
toast('Uploading...','');
uploadToCloudinary(fileInput.files[0],function(url){
if(url){
db.ref('worksheets').push({class:cls,subject:subj,title:title,url:url,createdAt:Date.now()}).then(function(){
closeM('wsModal');
document.getElementById('wsClass').value='';document.getElementById('wsSubject').value='';document.getElementById('wsTitle').value='';document.getElementById('wsFile').value='';
document.getElementById('filePreview').style.display='none';document.getElementById('uploadBox').style.display='block';
toast('Uploaded!','success');
});
}
});
}

function delWs(id){if(confirm('Delete?')){db.ref('worksheets/'+id).remove();toast('Deleted!','success')}}

function delWsById(el){
var id=el.getAttribute('data-id');
if(id&&confirm('Delete this worksheet?')){
db.ref('worksheets/'+id).remove();
toast('Deleted!','success');
}
}

// Parent Attendance Functions
function renPAtt(){
if(!cu||cu.role!=='parent')return;
var myAtt=att.filter(function(a){return a.sid===cu.id});
var total=myAtt.length,pres=myAtt.filter(function(a){return a.status==='present'}).length;
document.getElementById('pTotalDays').textContent=total;
document.getElementById('pPresentDays').textContent=pres;
document.getElementById('pAttPercent').textContent=total?Math.round((pres/total)*100)+'%':'0%';
// Group by month
var months={};
myAtt.forEach(function(a){
var d=new Date(a.date),k=d.toLocaleString('en-IN',{month:'long',year:'numeric'});
if(!months[k]){months[k]={p:[],a:[]}}
var day=d.getDate();
if(a.status==='present')months[k].p.push(day);else months[k].a.push(day);
});
var html='';
Object.keys(months).reverse().forEach(function(k){
var m=months[k],mp=Math.round((m.p.length/(m.p.length+m.a.length))*100);
html+='<div style="background:#fff;border-radius:16px;padding:15px;margin-bottom:12px"><h4 style="color:#667eea;margin-bottom:10px">ğŸ“… '+k+' ('+mp+'%)</h4>';
html+='<div style="margin-bottom:8px"><span style="color:#25D366;font-weight:600">Present ('+m.p.length+'): </span><span style="font-size:12px">'+m.p.sort(function(a,b){return a-b}).join(', ')+'</span></div>';
html+='<div><span style="color:#ff6b6b;font-weight:600">Absent ('+m.a.length+'): </span><span style="font-size:12px">'+(m.a.length?m.a.sort(function(a,b){return a-b}).join(', '):'-')+'</span></div></div>';
});
document.getElementById('pAttMonthList').innerHTML=html||'<div class="empty">No attendance records</div>';
}

function downloadPAttPDF(){
var s=stu.find(function(x){return x.id===cu.id});
if(!s)return;
var myAtt=att.filter(function(a){return a.sid===cu.id});
if(!myAtt.length)return toast('No attendance','error');
var months={};
myAtt.forEach(function(a){
var d=new Date(a.date),k=d.toLocaleString('en-IN',{month:'long',year:'numeric'});
if(!months[k]){months[k]={p:[],a:[]}}
var day=d.getDate();
if(a.status==='present')months[k].p.push(day);else months[k].a.push(day);
});
var jsPDF=window.jspdf.jsPDF,doc=new jsPDF();
doc.setFillColor(26,53,93);doc.rect(0,0,210,42,'F');
doc.setFillColor(237,137,54);doc.roundedRect(18,12,30,20,3,3,'F');
doc.setTextColor(255);doc.setFontSize(12);doc.setFont('helvetica','bold');
doc.text('USP',33,25,{align:'center'});
doc.setFontSize(18);doc.text('UNIQUE STUDY POINT',115,18,{align:'center'});
doc.setFontSize(9);doc.setFont('helvetica','normal');
doc.text('By Sumeet Sahu | www.uniquestudyonline.com',115,28,{align:'center'});
doc.setFillColor(237,137,54);doc.rect(0,42,210,11,'F');
doc.setFontSize(11);doc.setFont('helvetica','bold');
doc.text('ATTENDANCE REPORT - '+s.name,105,49,{align:'center'});
var tableData=[];
Object.keys(months).forEach(function(k){
var m=months[k],pct=Math.round((m.p.length/(m.p.length+m.a.length))*100);
var remark=pct>=90?'Excellent':pct>=75?'Good':pct>=50?'Average':'Poor';
tableData.push([k,m.p.length,m.p.sort(function(a,b){return a-b}).join(', '),m.a.length,m.a.length?m.a.sort(function(a,b){return a-b}).join(', '):'-',pct+'%',remark]);
});
doc.autoTable({startY:58,head:[['Month','P','Present Dates','A','Absent Dates','%','Remark']],body:tableData,theme:'grid',headStyles:{fillColor:[26,53,93],fontSize:8},bodyStyles:{fontSize:7}});
doc.setFillColor(26,53,93);doc.rect(0,280,210,17,'F');
doc.setTextColor(255);doc.setFontSize(7);
doc.text('www.uniquestudyonline.com | Contact: '+PHONE,105,290,{align:'center'});
doc.save(s.name+'_Attendance.pdf');toast('Downloaded!','success');
}

// Notification Badge - FIX 5: Proper update on new alerts
function updateNotifBadge(){
if(!cu||cu.role!=='parent')return;
var badge=document.getElementById('notifCount');
var notifBtn=document.getElementById('notifBadge');
if(!badge||!notifBtn)return;
var lastSeen=parseInt(localStorage.getItem('usp_lastSeen_'+cu.id)||'0');
// Count unread alerts for this student or ALL
var unread=0;
for(var i=0;i<alerts.length;i++){
var a=alerts[i];
if((a.sid===cu.id||a.sid==='ALL')&&(a.time||0)>lastSeen){
unread++;
}
}
// Update badge
badge.textContent=unread;
if(unread>0){
badge.style.display='flex';
badge.style.visibility='visible';
notifBtn.style.background='rgba(255,0,0,0.5)';
notifBtn.style.animation='pulse 1.5s infinite';
}else{
badge.style.display='none';
badge.style.visibility='hidden';
notifBtn.style.background='rgba(255,255,255,0.2)';
notifBtn.style.animation='none';
}
}

function markAlertsRead(){
if(cu&&cu.role==='parent'){
localStorage.setItem('usp_lastSeen_'+cu.id,Date.now().toString());
updateNotifBadge();
}
}

// Line Chart for Performance Trend
var lineChart=null;
function renderBarChart(myRes){
var box=document.getElementById('barChartBox');
if(myRes.length===0){box.style.display='none';return}
box.style.display='block';
var labels=[],data=[];
myRes.slice(0,10).reverse().forEach(function(r){
var pct=Math.round((r.marks/r.test.totalMarks)*100);
labels.push(r.test.name.substring(0,8));
data.push(pct);
});
if(lineChart)lineChart.destroy();
lineChart=new Chart(document.getElementById('barChart'),{
type:'line',
data:{labels:labels,datasets:[{label:'Score %',data:data,borderColor:'#667eea',backgroundColor:'rgba(102,126,234,0.1)',fill:true,tension:0.4,pointBackgroundColor:'#667eea',pointRadius:5}]},
options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{min:0,max:100}}}
});
}

// Fee Edit/Delete Functions
function openEditF(id){
var f=fee.find(function(x){return x.id===id});
if(!f)return;
document.getElementById('editFId').value=f.id;
document.getElementById('editFAmt').value=f.amount;
document.getElementById('editFDate').value=f.date;
document.getElementById('editFRemark').value=f.remark||'';
openM('editFModal');
}

function updateFee(){
var id=document.getElementById('editFId').value;
var amt=document.getElementById('editFAmt').value;
var d=document.getElementById('editFDate').value;
var rem=document.getElementById('editFRemark').value;
if(!amt)return toast('Enter amount','error');
db.ref('fees/'+id).update({amount:parseInt(amt),date:d,remark:rem}).then(function(){
closeM('editFModal');toast('Updated!','success');
});
}

function deleteFee(){
var id=document.getElementById('editFId').value;
if(confirm('Delete this fee record?')){
db.ref('fees/'+id).remove();
closeM('editFModal');toast('Deleted!','success');
}
}

// Alert Template
function setAlertTpl(msg){
document.getElementById('alertMsg').value=msg;
closeM('alertTplModal');
}


// Admin Alert Management
function renAdminAlerts(){
// Filter out ALL attendance alerts (both present and absent) - show only important alerts
var filtered=alerts.filter(function(a){
return !(a.category==='attendance'||a.msg&&(a.msg.indexOf(' was PRESENT')>-1||a.msg.indexOf(' was ABSENT')>-1));
});
var sorted=filtered.slice().sort(function(a,b){return(b.time||0)-(a.time||0)});
var html='';
sorted.forEach(function(a){
var type=getAlertType(a.msg);
var color=type==='negative'?'#ff6b6b':type==='positive'?'#25D366':'#667eea';
var stuName=a.sid==='ALL'?'ALL STUDENTS':stu.find(function(s){return s.id===a.sid})?.name||'Unknown';
html+='<div class="card" style="border-left:4px solid '+color+'"><div class="card-info"><div class="card-title">'+a.msg+'</div><div class="card-sub">To: '+stuName+' â€¢ '+formatDate(a.time)+'</div></div><button class="btn-small" style="background:#667eea" onclick="openEditAlert(\''+a.id+'\')">âœï¸</button><button class="btn-small btn-del" style="margin-left:5px" onclick="delAlert(\''+a.id+'\')">ğŸ—‘ï¸</button></div>';
});
document.getElementById('adminAlertList').innerHTML=html||'<div class="empty">No alerts</div>';
}

function openEditAlert(id){
var a=alerts.find(function(x){return x.id===id});
if(!a)return toast('Alert not found','error');
var stuName=a.sid==='ALL'?'ALL STUDENTS':stu.find(function(s){return s.id===a.sid})?.name||'Unknown';
document.getElementById('editAlertId').value=a.id;
document.getElementById('editAlertTo').value=stuName;
document.getElementById('editAlertMsg').value=a.msg;
document.getElementById('editAlertTime').value=formatDate(a.time);
openM('editAlertModal');
}

function updateAlert(){
var id=document.getElementById('editAlertId').value;
var msg=document.getElementById('editAlertMsg').value.trim();
if(!msg)return toast('Enter message','error');
db.ref('alerts/'+id).update({msg:msg}).then(function(){
closeM('editAlertModal');
toast('Alert Updated!','success');
setTimeout(renAdminAlerts,300);
});
}

function confirmDelAlert(){
var id=document.getElementById('editAlertId').value;
if(confirm('Delete this alert permanently?')){
db.ref('alerts/'+id).remove().then(function(){
closeM('editAlertModal');
toast('Deleted!','success');
setTimeout(renAdminAlerts,300);
});
}
}

function delAlert(id){
if(confirm('Delete this alert?')){
db.ref('alerts/'+id).remove().then(function(){
toast('Deleted!','success');
setTimeout(renAdminAlerts,300);
});
}
}

// Calculate Student Rank
function calculateRank(studentId){
var classStudents=stu.filter(function(s){
var target=stu.find(function(x){return x.id===studentId});
return target&&s.class===target.class;
});
var avgScores=[];
classStudents.forEach(function(s){
var myRes=res.filter(function(r){return r.sid===s.id});
if(myRes.length>0){
var total=0;
myRes.forEach(function(r){
var t=tst.find(function(x){return x.id===r.tid});
if(t)total+=Math.round((r.marks/t.totalMarks)*100);
});
avgScores.push({id:s.id,avg:Math.round(total/myRes.length)});
}else{
avgScores.push({id:s.id,avg:0});
}
});
avgScores.sort(function(a,b){return b.avg-a.avg});
var rank=1;
for(var i=0;i<avgScores.length;i++){
if(avgScores[i].id===studentId){rank=i+1;break}
}
return{rank:rank,total:classStudents.length,classAvg:avgScores.length?Math.round(avgScores.reduce(function(a,b){return a+b.avg},0)/avgScores.length):0};
}

// Auto Fee Reminder
function checkFeeReminder(){
if(!cu||cu.role!=='parent')return;
var s=stu.find(function(x){return x.id===cu.id});
if(!s)return;
var myFee=fee.filter(function(f){return f.sid===cu.id});
var paid=myFee.reduce(function(a,b){return a+b.amount},0);
var join=new Date(s.joinDate||td),now=new Date();
var months=Math.max(1,(now.getFullYear()-join.getFullYear())*12+(now.getMonth()-join.getMonth())+1);
var due=(s.fee||500)*months,pending=Math.max(0,due-paid);
if(pending>0){
var today=new Date().getDate();
var lastReminder=localStorage.getItem('usp_feeReminder_'+cu.id);
var thisMonth=new Date().getMonth()+'-'+new Date().getFullYear();
if(lastReminder!==thisMonth&&(today===1||today===5||today===10||today===15)){
db.ref('alerts').push({sid:cu.id,msg:'Fee Reminder: Rs.'+pending+' pending. Please clear your dues.',time:Date.now(),type:'info'});
localStorage.setItem('usp_feeReminder_'+cu.id,thisMonth);
}
}
}

// Generate Fee Receipt PDF
function genReceipt(fid){
var f=fee.find(function(x){return x.id===fid});
if(!f)return toast('Receipt not found','error');
var s=stu.find(function(x){return x.id===f.sid});
if(!s)return toast('Student not found','error');
var receiptNo='USP'+Date.now().toString().slice(-6);
var jsPDF=window.jspdf.jsPDF,doc=new jsPDF();

// Header
doc.setFillColor(26,53,93);doc.rect(0,0,210,45,'F');
doc.setFillColor(237,137,54);doc.roundedRect(15,10,35,25,3,3,'F');
doc.setTextColor(255);doc.setFontSize(14);doc.setFont('helvetica','bold');
doc.text('USP',32,26,{align:'center'});
doc.setFontSize(20);doc.text('UNIQUE STUDY POINT',120,20,{align:'center'});
doc.setFontSize(10);doc.setFont('helvetica','normal');
doc.text('By Sumeet Sahu | Amitesh Nagar, Indore',120,30,{align:'center'});
doc.text('www.uniquestudyonline.com | '+PHONE,120,38,{align:'center'});

// Receipt Title
doc.setFillColor(237,137,54);doc.rect(0,45,210,12,'F');
doc.setFontSize(12);doc.setFont('helvetica','bold');
doc.text('FEE RECEIPT',105,53,{align:'center'});

// Receipt Details Box
doc.setDrawColor(26,53,93);doc.setLineWidth(0.5);
doc.roundedRect(15,65,180,70,3,3,'S');

doc.setTextColor(26,53,93);doc.setFontSize(10);doc.setFont('helvetica','bold');
doc.text('Receipt No:',25,78);
doc.text('Date:',120,78);
doc.text('Student Name:',25,92);
doc.text('Class:',120,92);
doc.text('Mobile:',25,106);
doc.text('Amount Paid:',25,120);
doc.text('Remark:',120,120);

doc.setFont('helvetica','normal');doc.setTextColor(0);
doc.text(receiptNo,65,78);
doc.text(formatDate(f.date),145,78);
doc.text(s.name,65,92);
doc.text(s.class,145,92);
doc.text(s.mobile,65,106);
doc.setFontSize(14);doc.setFont('helvetica','bold');doc.setTextColor(34,139,34);
doc.text('Rs. '+f.amount+'/-',65,120);
doc.setFontSize(10);doc.setFont('helvetica','normal');doc.setTextColor(0);
doc.text(f.remark||'-',145,120);

// Amount in words
doc.setTextColor(26,53,93);doc.setFont('helvetica','bold');
doc.text('Amount in Words:',25,145);
doc.setFont('helvetica','normal');doc.setTextColor(0);
doc.text(numberToWords(f.amount)+' Rupees Only',75,145);

// Signature area
doc.setDrawColor(100);doc.setLineWidth(0.3);
doc.line(25,175,80,175);
doc.line(130,175,185,175);
doc.setFontSize(8);doc.setTextColor(100);
doc.text('Student/Parent Signature',35,180);
doc.text('Authorized Signature',145,180);

// Footer
doc.setFillColor(26,53,93);doc.rect(0,275,210,22,'F');
doc.setTextColor(255);doc.setFontSize(8);
doc.text('This is a computer generated receipt from UNIQUE STUDY POINT',105,283,{align:'center'});
doc.text('Thank you for your payment!',105,290,{align:'center'});

doc.save('Receipt_'+s.name+'_'+formatDate(f.date)+'.pdf');
toast('Receipt Downloaded!','success');
}

function numberToWords(n){
var a=['','One','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten','Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];
var b=['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
if(n<20)return a[n];
if(n<100)return b[Math.floor(n/10)]+(n%10?' '+a[n%10]:'');
if(n<1000)return a[Math.floor(n/100)]+' Hundred'+(n%100?' '+numberToWords(n%100):'');
if(n<100000)return numberToWords(Math.floor(n/1000))+' Thousand'+(n%1000?' '+numberToWords(n%1000):'');
return numberToWords(Math.floor(n/100000))+' Lakh'+(n%100000?' '+numberToWords(n%100000):'');
}

// Leave Request Functions
function submitLeave(){
if(!cu||cu.role!=='parent')return;
var from=document.getElementById('leaveFrom').value;
var to=document.getElementById('leaveTo').value;
var reason=document.getElementById('leaveReason').value.trim();
if(!from||!to||!reason)return toast('Fill all fields','error');
if(new Date(from)>new Date(to))return toast('Invalid dates','error');
var s=stu.find(function(x){return x.id===cu.id});
db.ref('leaves').push({
sid:cu.id,
name:s?s.name:'',
class:s?s.class:'',
fromDate:from,
toDate:to,
reason:reason,
status:'pending',
createdAt:Date.now()
}).then(function(){
document.getElementById('leaveFrom').value='';
document.getElementById('leaveTo').value='';
document.getElementById('leaveReason').value='';
toast('Leave request submitted!','success');
});
}

function renPLeave(){
if(!cu||cu.role!=='parent')return;
var myLeaves=leaves.filter(function(l){return l.sid===cu.id});
myLeaves.sort(function(a,b){return(b.createdAt||0)-(a.createdAt||0)});
var html='';
myLeaves.forEach(function(l){
var statusColor=l.status==='approved'?'#25D366':l.status==='rejected'?'#ff6b6b':'#f1c40f';
var statusIcon=l.status==='approved'?'âœ…':l.status==='rejected'?'âŒ':'â³';
html+='<div class="card" style="border-left:4px solid '+statusColor+'"><div class="card-info"><div class="card-title">'+formatDate(l.fromDate)+' to '+formatDate(l.toDate)+'</div><div class="card-sub">'+l.reason+'</div><div style="margin-top:5px;font-size:11px;font-weight:600;color:'+statusColor+'">'+statusIcon+' '+l.status.toUpperCase()+'</div></div></div>';
});
document.getElementById('pLeaveList').innerHTML=html||'<div class="empty">No leave requests</div>';
}

function renAdminLeave(){
var filtered=leaveFilter==='all'?leaves:leaves.filter(function(l){return l.status===leaveFilter});
filtered.sort(function(a,b){return(b.createdAt||0)-(a.createdAt||0)});
var html='';
filtered.forEach(function(l){
var statusColor=l.status==='approved'?'#25D366':l.status==='rejected'?'#ff6b6b':'#f1c40f';
html+='<div class="card" style="border-left:4px solid '+statusColor+'"><div class="card-info"><div class="card-title">'+l.name+' ('+l.class+')</div><div class="card-sub">'+formatDate(l.fromDate)+' to '+formatDate(l.toDate)+'</div><div style="font-size:11px;color:#666;margin-top:3px">'+l.reason+'</div></div>';
if(l.status==='pending'){
html+='<div style="display:flex;flex-direction:column;gap:5px"><button class="btn-small" style="background:#25D366" onclick="updateLeave(\''+l.id+'\',\'approved\')">âœ“</button><button class="btn-small btn-del" onclick="updateLeave(\''+l.id+'\',\'rejected\')">âœ—</button></div>';
}else{
html+='<span style="font-size:11px;font-weight:600;color:'+statusColor+'">'+(l.status==='approved'?'âœ…':'âŒ')+'</span>';
}
html+='</div>';
});
document.getElementById('adminLeaveList').innerHTML=html||'<div class="empty">No leave requests</div>';
}

function setLeaveF(btn,f){
document.querySelectorAll('#aLeave .filter-btn').forEach(function(b){b.classList.remove('active')});
btn.classList.add('active');
leaveFilter=f;
renAdminLeave();
}

function updateLeave(id,status){
db.ref('leaves/'+id).update({status:status}).then(function(){
var l=leaves.find(function(x){return x.id===id});
if(l){
var msg=status==='approved'?'Your leave request ('+formatDate(l.fromDate)+' to '+formatDate(l.toDate)+') has been APPROVED.':'Your leave request ('+formatDate(l.fromDate)+' to '+formatDate(l.toDate)+') has been REJECTED.';
db.ref('alerts').push({sid:l.sid,msg:msg,time:Date.now(),type:status==='approved'?'positive':'negative'});
}
toast('Leave '+status+'!','success');
});
}

// Analytics Functions
function renAnalytics(){
renderToppers();
renderWeakStudents();
renderLowAttendance();
renderFeePending();
}

function renderToppers(){
var classes=['VI','VII','VIII','IX','X'];
var html='';
classes.forEach(function(cls){
var clsStu=stu.filter(function(s){return s.class===cls});
if(clsStu.length===0)return;
var scores=[];
clsStu.forEach(function(s){
var myRes=res.filter(function(r){return r.sid===s.id});
if(myRes.length>0){
var total=0;
myRes.forEach(function(r){
var t=tst.find(function(x){return x.id===r.tid});
if(t)total+=Math.round((r.marks/t.totalMarks)*100);
});
scores.push({id:s.id,name:s.name,avg:Math.round(total/myRes.length),tests:myRes.length});
}
});
scores.sort(function(a,b){return b.avg-a.avg});
var top5=scores.slice(0,5);
if(top5.length>0){
html+='<div style="background:#fff;border-radius:12px;padding:12px;margin-bottom:12px"><h4 style="color:#667eea;margin-bottom:8px">ğŸ† Class '+cls+'</h4>';
top5.forEach(function(s,i){
var medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'';
html+='<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f0f0f0"><span>'+medal+' #'+(i+1)+' '+s.name+'</span><span style="font-weight:700;color:#25D366">'+s.avg+'%</span></div>';
});
html+='</div>';
}
});
document.getElementById('topperList').innerHTML=html||'<div class="empty">No data yet</div>';
}

function renderWeakStudents(){
var weak=[];
stu.forEach(function(s){
var myRes=res.filter(function(r){return r.sid===s.id});
if(myRes.length>0){
var total=0;
myRes.forEach(function(r){
var t=tst.find(function(x){return x.id===r.tid});
if(t)total+=Math.round((r.marks/t.totalMarks)*100);
});
var avg=Math.round(total/myRes.length);
if(avg<40)weak.push({id:s.id,name:s.name,class:s.class,avg:avg,mobile:s.mobile});
}
});
weak.sort(function(a,b){return a.avg-b.avg});
var html='';
if(weak.length>0){
html+='<div style="background:#fff;border-radius:12px;padding:12px">';
weak.forEach(function(s){
html+='<div class="card" style="border-left:4px solid #ff6b6b;margin-bottom:8px"><div class="card-info"><div class="card-title">'+s.name+'</div><div class="card-sub">Class '+s.class+' â€¢ Average: <span style="color:#ff6b6b;font-weight:700">'+s.avg+'%</span></div></div><button class="btn-small btn-sms" onclick="alertOneParent(\''+s.id+'\',\'weak\')">ğŸ“±</button></div>';
});
html+='</div>';
}
document.getElementById('weakList').innerHTML=html||'<div class="empty" style="color:#25D366">âœ… No weak students! Great job!</div>';
}

function renderLowAttendance(){
var lowAtt=[];
stu.forEach(function(s){
var myAtt=att.filter(function(a){return a.sid===s.id});
if(myAtt.length>0){
var pres=myAtt.filter(function(a){return a.status==='present'}).length;
var pct=Math.round((pres/myAtt.length)*100);
if(pct<75)lowAtt.push({id:s.id,name:s.name,class:s.class,present:pres,total:myAtt.length,pct:pct,mobile:s.mobile});
}
});
lowAtt.sort(function(a,b){return a.pct-b.pct});
var html='';
if(lowAtt.length>0){
html+='<div style="background:#fff;border-radius:12px;padding:12px">';
lowAtt.forEach(function(s){
var color=s.pct<50?'#ff6b6b':s.pct<65?'#f1c40f':'#667eea';
html+='<div class="card" style="border-left:4px solid '+color+';margin-bottom:8px"><div class="card-info"><div class="card-title">'+s.name+'</div><div class="card-sub">Class '+s.class+' â€¢ '+s.present+'/'+s.total+' days â€¢ <span style="color:'+color+';font-weight:700">'+s.pct+'%</span></div></div><button class="btn-small btn-sms" onclick="alertOneParent(\''+s.id+'\',\'attendance\')">ğŸ“±</button></div>';
});
html+='</div>';
}
document.getElementById('lowAttList').innerHTML=html||'<div class="empty" style="color:#25D366">âœ… All students have good attendance!</div>';
}

function alertOneParent(sid,type){
var s=stu.find(function(x){return x.id===sid});
if(!s)return;
var msg='';
if(type==='weak'){
var myRes=res.filter(function(r){return r.sid===sid});
var total=0;myRes.forEach(function(r){var t=tst.find(function(x){return x.id===r.tid});if(t)total+=Math.round((r.marks/t.totalMarks)*100)});
var avg=myRes.length?Math.round(total/myRes.length):0;
msg='Dear Parent, '+s.name+'\'s average score is '+avg+'%. Please pay attention to studies. - UNIQUE STUDY POINT';
}else{
var myAtt=att.filter(function(a){return a.sid===sid});
var pres=myAtt.filter(function(a){return a.status==='present'}).length;
var pct=myAtt.length?Math.round((pres/myAtt.length)*100):0;
msg='Dear Parent, '+s.name+'\'s attendance is '+pct+'% ('+pres+'/'+myAtt.length+' days). Regular attendance is important. - UNIQUE STUDY POINT';
}
db.ref('alerts').push({sid:sid,msg:msg,time:Date.now(),type:'negative'});
toast('Alert sent to '+s.name+'\'s parent!','success');
}

function alertWeakParents(){
var weak=[];
stu.forEach(function(s){
var myRes=res.filter(function(r){return r.sid===s.id});
if(myRes.length>0){
var total=0;myRes.forEach(function(r){var t=tst.find(function(x){return x.id===r.tid});if(t)total+=Math.round((r.marks/t.totalMarks)*100)});
var avg=Math.round(total/myRes.length);
if(avg<40)weak.push({id:s.id,name:s.name,avg:avg});
}
});
if(weak.length===0)return toast('No weak students!','success');
if(!confirm('Send alert to '+weak.length+' weak students\' parents?'))return;
weak.forEach(function(s){
var msg='Dear Parent, your child\'s average score is '+s.avg+'%. Please pay attention to studies. - UNIQUE STUDY POINT';
db.ref('alerts').push({sid:s.id,msg:msg,time:Date.now(),type:'negative'});
});
toast('Alerts sent to '+weak.length+' parents!','success');
}

function alertLowAttParents(){
var lowAtt=[];
stu.forEach(function(s){
var myAtt=att.filter(function(a){return a.sid===s.id});
if(myAtt.length>0){
var pres=myAtt.filter(function(a){return a.status==='present'}).length;
var pct=Math.round((pres/myAtt.length)*100);
if(pct<75)lowAtt.push({id:s.id,name:s.name,pres:pres,total:myAtt.length,pct:pct});
}
});
if(lowAtt.length===0)return toast('All students have good attendance!','success');
if(!confirm('Send alert to '+lowAtt.length+' low attendance students\' parents?'))return;
lowAtt.forEach(function(s){
var msg='Dear Parent, your child\'s attendance is '+s.pct+'% ('+s.pres+'/'+s.total+' days). Regular attendance is important. - UNIQUE STUDY POINT';
db.ref('alerts').push({sid:s.id,msg:msg,time:Date.now(),type:'negative'});
});
toast('Alerts sent to '+lowAtt.length+' parents!','success');
}

// Generate All Monthly Reports
function genAllReports(){
if(stu.length===0)return toast('No students!','error');
if(!confirm('Generate reports for all '+stu.length+' students?'))return;
toast('Generating reports...','');
var count=0;
stu.forEach(function(s,idx){
setTimeout(function(){
genSingleReport(s);
count++;
if(count===stu.length)toast('All '+count+' reports generated!','success');
},idx*500);
});
}

function genSingleReport(s){
var myRes=res.filter(function(r){return r.sid===s.id});
var myAtt=att.filter(function(a){return a.sid===s.id});
var totalMarks=0,totalMax=0,subjects={};
myRes.forEach(function(r){
var t=tst.find(function(x){return x.id===r.tid});
if(t){
totalMarks+=r.marks;totalMax+=t.totalMarks;
if(!subjects[t.subject])subjects[t.subject]={total:0,cnt:0};
subjects[t.subject].total+=Math.round((r.marks/t.totalMarks)*100);
subjects[t.subject].cnt++;
}
});
var avgPct=totalMax?Math.round((totalMarks/totalMax)*100):0;
var overall=getGrade(avgPct);
var pres=myAtt.filter(function(a){return a.status==='present'}).length;
var attPct=myAtt.length?Math.round((pres/myAtt.length)*100):0;

var jsPDF=window.jspdf.jsPDF,doc=new jsPDF();
// Header
doc.setFillColor(26,53,93);doc.rect(0,0,210,42,'F');
doc.setFillColor(237,137,54);doc.roundedRect(15,10,35,25,3,3,'F');
doc.setTextColor(255);doc.setFontSize(14);doc.setFont('helvetica','bold');
doc.text('USP',32,26,{align:'center'});
doc.setFontSize(18);doc.text('UNIQUE STUDY POINT',120,18,{align:'center'});
doc.setFontSize(9);doc.setFont('helvetica','normal');
doc.text('By Sumeet Sahu | Excellence in Education',120,26,{align:'center'});
doc.text('Amitesh Nagar, Indore, M.P. | www.uniquestudyonline.com',120,34,{align:'center'});
doc.setFillColor(237,137,54);doc.rect(0,42,210,11,'F');
doc.setFontSize(11);doc.setFont('helvetica','bold');
doc.text('MONTHLY PROGRESS REPORT - '+getMonth().toUpperCase(),105,49,{align:'center'});
// Info
doc.setDrawColor(26,53,93);doc.setLineWidth(0.5);doc.roundedRect(14,58,182,16,2,2,'S');
doc.setTextColor(26,53,93);doc.setFontSize(9);doc.setFont('helvetica','bold');
doc.text('Student: '+s.name,18,67);doc.text('Class: '+s.class,90,67);doc.text('Roll: '+s.userId,140,67);
// Summary
doc.setFillColor(26,53,93);doc.roundedRect(14,78,182,14,2,2,'F');
doc.setTextColor(255);doc.setFontSize(9);
doc.text('Tests: '+myRes.length,30,87);doc.text('Average: '+avgPct+'%',70,87);doc.text('Grade: '+overall.g,115,87);doc.text('Attendance: '+attPct+'%',155,87);
// Footer
doc.setFillColor(26,53,93);doc.rect(0,280,210,17,'F');
doc.setTextColor(255);doc.setFontSize(7);
doc.text('UNIQUE STUDY POINT | www.uniquestudyonline.com | '+PHONE,105,290,{align:'center'});
doc.save(s.name.replace(/\s+/g,'_')+'_Report.pdf');
}

// Parent Badges
function renderParentBadges(){
if(!cu||cu.role!=='parent')return;
var html='';
// Check rank
var rankInfo=calculateRank(cu.id);
if(rankInfo.rank<=5){
html+='<div style="background:linear-gradient(135deg,#f1c40f,#f39c12);color:#fff;padding:12px;border-radius:12px;margin-bottom:8px;text-align:center"><span style="font-size:18px">ğŸ†</span> <strong>Congratulations!</strong> You are #'+rankInfo.rank+' in your class!</div>';
}
// Check weak
var myRes=res.filter(function(r){return r.sid===cu.id});
if(myRes.length>0){
var total=0;myRes.forEach(function(r){var t=tst.find(function(x){return x.id===r.tid});if(t)total+=Math.round((r.marks/t.totalMarks)*100)});
var avg=Math.round(total/myRes.length);
if(avg<40){
html+='<div style="background:linear-gradient(135deg,#ff6b6b,#ee5a5a);color:#fff;padding:12px;border-radius:12px;margin-bottom:8px;text-align:center"><span style="font-size:18px">âš ï¸</span> Your average is <strong>'+avg+'%</strong>. Need more practice!</div>';
}
}
// Check attendance
var myAtt=att.filter(function(a){return a.sid===cu.id});
if(myAtt.length>0){
var pres=myAtt.filter(function(a){return a.status==='present'}).length;
var attPct=Math.round((pres/myAtt.length)*100);
if(attPct<75){
html+='<div style="background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff;padding:12px;border-radius:12px;margin-bottom:8px;text-align:center"><span style="font-size:18px">ğŸ“‹</span> Attendance is <strong>'+attPct+'%</strong>. Regular attendance is important!</div>';
}else if(attPct>=95){
html+='<div style="background:linear-gradient(135deg,#25D366,#128C7E);color:#fff;padding:12px;border-radius:12px;margin-bottom:8px;text-align:center"><span style="font-size:18px">â­</span> <strong>Excellent!</strong> '+attPct+'% attendance. Keep it up!</div>';
}
}
document.getElementById('parentBadges').innerHTML=html;
}

// Fee Pending Functions
function renderFeePending(){
var pending=[];
stu.forEach(function(s){
var myFee=fee.filter(function(f){return f.sid===s.id});
var paid=myFee.reduce(function(a,b){return a+b.amount},0);
var join=new Date(s.joinDate||td),now=new Date();
var months=Math.max(1,(now.getFullYear()-join.getFullYear())*12+(now.getMonth()-join.getMonth())+1);
var due=(s.fee||500)*months;
var pend=Math.max(0,due-paid);
if(pend>0)pending.push({id:s.id,name:s.name,class:s.class,paid:paid,due:due,pending:pend,mobile:s.mobile});
});
pending.sort(function(a,b){return b.pending-a.pending});
var html='';
if(pending.length>0){
html+='<div style="background:#fff;border-radius:12px;padding:12px">';
pending.forEach(function(s){
html+='<div class="card" style="border-left:4px solid #f39c12;margin-bottom:8px"><div class="card-info"><div class="card-title">'+s.name+'</div><div class="card-sub">Class '+s.class+' â€¢ Paid: â‚¹'+s.paid+' â€¢ <span style="color:#ff6b6b;font-weight:700">Pending: â‚¹'+s.pending+'</span></div></div><button class="btn-small btn-sms" onclick="sendFeeReminder(\''+s.id+'\')">ğŸ“±</button></div>';
});
html+='</div>';
}
document.getElementById('feePendingList').innerHTML=html||'<div class="empty" style="color:#25D366">âœ… All fees cleared!</div>';
}

function sendFeeReminder(sid){
var s=stu.find(function(x){return x.id===sid});
if(!s)return;
var myFee=fee.filter(function(f){return f.sid===sid});
var paid=myFee.reduce(function(a,b){return a+b.amount},0);
var join=new Date(s.joinDate||td),now=new Date();
var months=Math.max(1,(now.getFullYear()-join.getFullYear())*12+(now.getMonth()-join.getMonth())+1);
var due=(s.fee||500)*months;
var pend=Math.max(0,due-paid);
var msg='Fee Reminder: Rs.'+pend+'/- pending. Please clear your dues at the earliest. - UNIQUE STUDY POINT';
db.ref('alerts').push({sid:sid,msg:msg,time:Date.now(),type:'info'});
toast('Fee reminder sent to '+s.name+'!','success');
}

function alertFeePending(){
var pending=[];
stu.forEach(function(s){
var myFee=fee.filter(function(f){return f.sid===s.id});
var paid=myFee.reduce(function(a,b){return a+b.amount},0);
var join=new Date(s.joinDate||td),now=new Date();
var months=Math.max(1,(now.getFullYear()-join.getFullYear())*12+(now.getMonth()-join.getMonth())+1);
var due=(s.fee||500)*months;
var pend=Math.max(0,due-paid);
if(pend>0)pending.push({id:s.id,name:s.name,pending:pend});
});
if(pending.length===0)return toast('All fees cleared!','success');
if(!confirm('Send fee reminder to '+pending.length+' students?'))return;
pending.forEach(function(s){
var msg='Fee Reminder: Rs.'+s.pending+'/- pending. Please clear your dues at the earliest. - UNIQUE STUDY POINT';
db.ref('alerts').push({sid:s.id,msg:msg,time:Date.now(),type:'info'});
});
toast('Fee reminders sent to '+pending.length+' parents!','success');
}

// Individual Attendance SMS
function sendIndAttSMS(sid){
var s=stu.find(function(x){return x.id===sid});
if(!s)return toast('Student not found','error');
var d=document.getElementById('attD').value||td;
var a=att.find(function(x){return x.sid===sid&&x.date===d});
if(!a)return toast('Mark attendance first','error');
var status=a.status==='present'?'PRESENT âœ…':'ABSENT âŒ';
var msg=s.name+' was '+status+' on '+formatDate(d)+'. - UNIQUE STUDY POINT';
// Send SMS
var nums=getAllMobiles(s).join(',');
fetch('https://www.fast2sms.com/dev/bulkV2?authorization=P3WtxzoqRgB58mSnZ1vJAwGQ2p7UTY0ci6dLjlhbkDCf4auKHI2qKczUL1AMVRj6WSDItJekFaZxP8no&route=q&message='+encodeURIComponent(msg)+'&flash=0&numbers='+nums,{method:'GET',mode:'no-cors'});
// App notification for BOTH present and absent (category:attendance so admin can filter)
db.ref('alerts').push({sid:sid,msg:s.name+' was '+status+' on '+formatDate(d),time:Date.now(),type:a.status==='present'?'positive':'negative',category:'attendance'});
toast('SMS sent to '+s.name+'\'s parent!','success');
}

// Birthday Alert Functions
function checkBirthdays(){
var today=new Date();
var todayStr=(today.getMonth()+1).toString().padStart(2,'0')+'-'+today.getDate().toString().padStart(2,'0');
var birthdays=[];
stu.forEach(function(s){
if(s.dob){
var dob=new Date(s.dob);
var dobStr=(dob.getMonth()+1).toString().padStart(2,'0')+'-'+dob.getDate().toString().padStart(2,'0');
if(todayStr===dobStr){
birthdays.push(s);
}
}
});
return birthdays;
}

function sendBirthdayAlerts(){
var birthdays=checkBirthdays();
if(birthdays.length===0)return;
var lastSent=localStorage.getItem('usp_birthday_'+td);
if(lastSent)return;
birthdays.forEach(function(s){
var msg='ğŸ‚ Happy Birthday '+s.name+'! Wishing you a wonderful year ahead. - UNIQUE STUDY POINT';
db.ref('alerts').push({sid:s.id,msg:msg,time:Date.now(),type:'positive'});
// Also send SMS
var nums=getAllMobiles(s).join(',');
fetch('https://www.fast2sms.com/dev/bulkV2?authorization=P3WtxzoqRgB58mSnZ1vJAwGQ2p7UTY0ci6dLjlhbkDCf4auKHI2qKczUL1AMVRj6WSDItJekFaZxP8no&route=q&message='+encodeURIComponent(msg)+'&flash=0&numbers='+nums,{method:'GET',mode:'no-cors'});
});
localStorage.setItem('usp_birthday_'+td,'sent');
if(birthdays.length>0)toast('ğŸ‚ Birthday wishes sent to '+birthdays.length+' student(s)!','success');
}

function renderBirthdayBanner(){
var birthdays=checkBirthdays();
if(birthdays.length===0)return '';
var names=birthdays.map(function(s){return s.name}).join(', ');
return '<div style="background:linear-gradient(135deg,#f1c40f,#e67e22);color:#fff;padding:15px;margin:0 20px 15px;border-radius:16px;text-align:center"><span style="font-size:24px">ğŸ‚</span><br><strong>Today\'s Birthday!</strong><br>'+names+'</div>';
}

// Clear Data Functions
function clearAttendance(){
if(!confirm('Delete ALL attendance records?'))return;
if(!confirm('Are you SURE? This cannot be undone!'))return;
db.ref('attendance').remove().then(function(){
toast('All attendance deleted!','success');
renAnalytics();
});
}

function clearTests(){
if(!confirm('Delete ALL tests and results?'))return;
if(!confirm('Are you SURE? This cannot be undone!'))return;
db.ref('tests').remove();
db.ref('results').remove().then(function(){
toast('All tests & results deleted!','success');
renAnalytics();
});
}

function clearAlerts(){
if(!confirm('Delete ALL alerts?'))return;
if(!confirm('Are you SURE? This cannot be undone!'))return;
db.ref('alerts').remove().then(function(){
toast('All alerts deleted!','success');
renAnalytics();
});
}

function clearFees(){
if(!confirm('Delete ALL fee records?'))return;
if(!confirm('Are you SURE? This cannot be undone!'))return;
db.ref('fees').remove().then(function(){
toast('All fee records deleted!','success');
renAnalytics();
});
}

function clearAllData(){
if(!confirm('âš ï¸ DELETE ALL DATA (Attendance, Tests, Results, Alerts, Fees)?'))return;
if(!confirm('âš ï¸ Are you ABSOLUTELY SURE? This cannot be undone!'))return;
if(prompt('Type "DELETE" to confirm:')!=='DELETE')return toast('Cancelled','error');
db.ref('attendance').remove();
db.ref('tests').remove();
db.ref('results').remove();
db.ref('alerts').remove();
db.ref('fees').remove();
db.ref('leaves').remove().then(function(){
toast('All data cleared! Students are safe.','success');
renAnalytics();
});
}

// Clear file selection
function clearFileSelection(){
document.getElementById('wsFile').value='';
document.getElementById('filePreview').style.display='none';
document.getElementById('uploadBox').style.display='block';
}

// Send Push Notification
function sendPushNotification(sid,title,body){
// Get FCM token for student
db.ref('fcmTokens/'+sid).once('value').then(function(snap){
var data=snap.val();
if(data&&data.token){
// Store notification in database for server to send
db.ref('pushQueue').push({
token:data.token,
title:title,
body:body,
createdAt:Date.now()
});
}
});
}

// PTM Report PDF Generation
function genPTMReport(sid){
var s=stu.find(function(x){return x.id===sid});
if(!s)return toast('Student not found','error');

var {jsPDF}=window.jspdf;
var doc=new jsPDF();
var y=15;

// Header
doc.setFillColor(102,126,234);
doc.rect(0,0,210,40,'F');
doc.setTextColor(255,255,255);
doc.setFontSize(20);
doc.setFont('helvetica','bold');
doc.text('UNIQUE STUDY POINT',105,18,{align:'center'});
doc.setFontSize(14);
doc.text('STUDENT ACADEMIC REPORT (PTM)',105,28,{align:'center'});
doc.setFontSize(10);
doc.text('Generated: '+formatDate(Date.now()),105,36,{align:'center'});

// Student Info
y=50;
doc.setTextColor(0,0,0);
doc.setFontSize(12);
doc.setFont('helvetica','bold');
doc.text('STUDENT INFORMATION',15,y);
doc.setFont('helvetica','normal');
y+=8;
doc.text('Name: '+s.name,15,y);
doc.text('Class: '+s.class,120,y);
y+=6;
doc.text('Mobile: '+s.mobile,15,y);
doc.text('DOB: '+(s.dob||'N/A'),120,y);
y+=6;
doc.text('Join Date: '+(s.joinDate||'N/A'),15,y);

// Attendance Summary
y+=12;
doc.setFont('helvetica','bold');
doc.text('ATTENDANCE SUMMARY',15,y);
doc.setFont('helvetica','normal');
y+=8;
var myAtt=att.filter(function(a){return a.sid===sid});
var present=myAtt.filter(function(a){return a.status==='present'}).length;
var absent=myAtt.filter(function(a){return a.status==='absent'}).length;
var total=present+absent;
var attPct=total>0?Math.round((present/total)*100):0;
doc.text('Total Days: '+total+'    Present: '+present+'    Absent: '+absent+'    Attendance: '+attPct+'%',15,y);

// Test Performance
y+=12;
doc.setFont('helvetica','bold');
doc.text('TEST PERFORMANCE',15,y);
y+=8;

var myRes=res.filter(function(r){return r.sid===sid});
if(myRes.length>0){
var testData=[];
var totalPct=0;
myRes.forEach(function(r){
var t=tst.find(function(x){return x.id===r.tid});
if(t&&r.marks>=0){
var pct=Math.round((r.marks/t.totalMarks)*100);
totalPct+=pct;
testData.push([t.name,t.subject||'General',r.marks+'/'+t.totalMarks,pct+'%']);
}
});
var avgPct=testData.length>0?Math.round(totalPct/testData.length):0;

doc.autoTable({
head:[['Test Name','Subject','Marks','Percentage']],
body:testData,
startY:y,
theme:'grid',
headStyles:{fillColor:[102,126,234]},
styles:{fontSize:9}
});
y=doc.lastAutoTable.finalY+5;
doc.setFont('helvetica','bold');
doc.text('Average: '+avgPct+'%',15,y);

// Class Rank
var rank=calculateRank(sid);
doc.text('Class Rank: #'+rank.rank+' out of '+rank.total,100,y);
}else{
doc.setFont('helvetica','normal');
doc.text('No test records found.',15,y);
}

// Fee Status
y+=12;
doc.setFont('helvetica','bold');
doc.text('FEE STATUS',15,y);
doc.setFont('helvetica','normal');
y+=8;
var myFee=fee.filter(function(f){return f.sid===sid});
var totalPaid=myFee.reduce(function(a,b){return a+(b.amount||0)},0);
var monthlyFee=s.fee||500;
var joinDate=s.joinDate?new Date(s.joinDate):new Date();
var months=Math.max(1,Math.ceil((Date.now()-joinDate.getTime())/(30*24*60*60*1000)));
var totalDue=months*monthlyFee;
var pending=totalDue-totalPaid;
doc.text('Monthly Fee: Rs.'+monthlyFee+'    Total Paid: Rs.'+totalPaid+'    Pending: Rs.'+(pending>0?pending:0),15,y);

// Leave Record
y+=12;
doc.setFont('helvetica','bold');
doc.text('LEAVE RECORD',15,y);
doc.setFont('helvetica','normal');
y+=8;
var myLeaves=leaves.filter(function(l){return l.sid===sid});
if(myLeaves.length>0){
myLeaves.slice(0,5).forEach(function(l){
doc.text(formatDate(l.date)+' - '+l.reason+' ('+l.status+')',15,y);
y+=5;
});
}else{
doc.text('No leave records.',15,y);
}

// Alerts/Remarks
y+=8;
doc.setFont('helvetica','bold');
doc.text('REMARKS/ALERTS SENT',15,y);
doc.setFont('helvetica','normal');
y+=8;
var myAlerts=alerts.filter(function(a){return a.sid===sid||a.sid==='ALL'}).slice(0,5);
if(myAlerts.length>0){
myAlerts.forEach(function(a){
var msg=a.msg.length>60?a.msg.substring(0,60)+'...':a.msg;
doc.text('â€¢ '+msg+' ('+formatDate(a.time)+')',15,y);
y+=5;
});
}else{
doc.text('No remarks.',15,y);
}

// Footer
doc.setFillColor(102,126,234);
doc.rect(0,280,210,17,'F');
doc.setTextColor(255,255,255);
doc.setFontSize(10);
doc.text('UNIQUE STUDY POINT BY SUMEET SAHU | Mobile: 8103405051',105,290,{align:'center'});

doc.save(s.name.replace(/\s+/g,'_')+'_PTM_Report.pdf');
toast('PTM Report Downloaded!','success');
}
</script>
</body>
</html>
